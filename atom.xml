<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Norld&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://norld.com/"/>
  <updated>2019-04-28T15:23:49.995Z</updated>
  <id>http://norld.com/</id>
  
  <author>
    <name>Norld</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æ­å»º Docker + Flask åç«¯</title>
    <link href="http://norld.com/2018/12/26/DockerFlaskApi/"/>
    <id>http://norld.com/2018/12/26/DockerFlaskApi/</id>
    <published>2018-12-26T07:38:50.000Z</published>
    <updated>2019-04-28T15:23:49.995Z</updated>
    
    <content type="html"><![CDATA[<h1 id="æ­å»º-Docker-Flask-åç«¯"><a href="#æ­å»º-Docker-Flask-åç«¯" class="headerlink" title="æ­å»º Docker + Flask åç«¯"></a>æ­å»º Docker + Flask åç«¯</h1><p>ä½¿ç”¨ Docker + Flask + Gunicorn + Gevent + nginx æ¥æ­å»ºçº¯ API åç«¯</p><h1 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h1><p>ä½¿ç”¨ Docker ç¼–æ’ç®¡ç†æœåŠ¡, ä½¿ç”¨ Shell è„šæœ¬ä¸€é”®åŒ–éƒ¨ç½²æµç¨‹</p><a id="more"></a><h1 id="ç¬¬ä¸€æ­¥"><a href="#ç¬¬ä¸€æ­¥" class="headerlink" title="ç¬¬ä¸€æ­¥"></a>ç¬¬ä¸€æ­¥</h1><p>åˆ›å»ºç›®å½•/æ–‡ä»¶, ç»“æ„å¦‚ä¸‹:</p><p>site<br>|â€“ flask<br>&nbsp;&nbsp;&nbsp;&nbsp;|â€“ Dockerfile<br>&nbsp;&nbsp;&nbsp;&nbsp;|â€“ server<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“ config<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“ gunicorn.conf.py<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“ app.py<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|â€“ requirements.txt<br>|â€“ nginx<br>&nbsp;&nbsp;&nbsp;&nbsp;|â€“ default.conf<br>|â€“ docker-compose.yml<br>|â€“ deploy.sh</p><h1 id="ç¬¬äºŒæ­¥"><a href="#ç¬¬äºŒæ­¥" class="headerlink" title="ç¬¬äºŒæ­¥"></a>ç¬¬äºŒæ­¥</h1><h4 id="flask-Dockerfile"><a href="#flask-Dockerfile" class="headerlink" title="flask/Dockerfile"></a>flask/Dockerfile</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.7</span><br><span class="line"></span><br><span class="line">COPY ./server /workspace</span><br><span class="line">WORKDIR /workspace</span><br><span class="line"></span><br><span class="line">RUN pip install -i https://mirrors.aliyun.com/pypi/simple/ --upgrade pip \</span><br><span class="line">&amp;&amp; pip --no-cache-dir install -i https://mirrors.aliyun.com/pypi/simple/ -r requirements.txt</span><br><span class="line"></span><br><span class="line">EXPOSE 5000</span><br><span class="line"></span><br><span class="line">CMD [&quot;gunicorn&quot;, &quot;app:app&quot;, &quot;-c&quot;, &quot;./config/gunicorn.conf.py&quot;]</span><br></pre></td></tr></table></figure><h4 id="flask-server-requirements-txt"><a href="#flask-server-requirements-txt" class="headerlink" title="flask/server/requirements.txt"></a>flask/server/requirements.txt</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flask==1.0.2</span><br><span class="line">gunicorn==19.9.0</span><br><span class="line">gevent==1.4.0</span><br></pre></td></tr></table></figure><h4 id="flask-server-app-py"><a href="#flask-server-app-py" class="headerlink" title="flask/server/app.py"></a>flask/server/app.py</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&apos;/&apos;)</span><br><span class="line">def hello_world():</span><br><span class="line">    return &apos;Hello, World!&apos;</span><br></pre></td></tr></table></figure><h4 id="flask-server-config-gunicorn-conf-py"><a href="#flask-server-config-gunicorn-conf-py" class="headerlink" title="flask/server/config/gunicorn.conf.py"></a>flask/server/config/gunicorn.conf.py</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">workers = 5</span><br><span class="line">worker_class = &quot;gevent&quot;</span><br><span class="line">bind = &quot;0.0.0.0:5000&quot;</span><br><span class="line">loglevel = &apos;debug&apos;</span><br></pre></td></tr></table></figure><h4 id="nginx-default-conf"><a href="#nginx-default-conf" class="headerlink" title="nginx/default.conf"></a>nginx/default.conf</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name api.site.com;</span><br><span class="line">    listen [::]:80;</span><br><span class="line">    server_tokens off;</span><br><span class="line">    client_max_body_size 15M;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/nginx.api.access.log;</span><br><span class="line">    error_log   /var/log/nginx/nginx.api.error.log;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header Host $http_host;</span><br><span class="line">        proxy_set_header X-NginX-Proxy true;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://flask:5000;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="docker-compose-yml"><a href="#docker-compose-yml" class="headerlink" title="docker-compose.yml"></a>docker-compose.yml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx:/etc/nginx/conf.d</span><br><span class="line">      - /var/log/nginx:/var/log/nginx</span><br><span class="line">    links:</span><br><span class="line">      - flask</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">  flask:</span><br><span class="line">    build:</span><br><span class="line">      context: ./flask</span><br></pre></td></tr></table></figure><h4 id="deploy-sh"><a href="#deploy-sh" class="headerlink" title="deploy.sh"></a>deploy.sh</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">rm -rf &apos;tmp.tar&apos;</span><br><span class="line">cd &apos;..&apos;</span><br><span class="line">tar cf &apos;tmp.tar&apos; &apos;site&apos;</span><br><span class="line">mv &apos;tmp.tar&apos; &apos;site/tmp.tar&apos;</span><br><span class="line">cd &apos;site&apos;</span><br><span class="line"></span><br><span class="line">sftp &apos;root@api.norld.com&apos; &lt;&lt;EOF</span><br><span class="line">cd &apos;/root&apos;</span><br><span class="line">put &apos;tmp.tar&apos;</span><br><span class="line">exit</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">rm -rf &apos;tmp.tar&apos;</span><br><span class="line"></span><br><span class="line">ssh &apos;user@api.site.com&apos; &lt;&lt;EOF</span><br><span class="line">rm -rf &apos;site&apos;</span><br><span class="line">tar xf &apos;tmp.tar&apos;</span><br><span class="line">cd &apos;site&apos;</span><br><span class="line">docker-compose down</span><br><span class="line">docker-compose up --build -d</span><br><span class="line">echo &apos;y&apos; | docker image prune</span><br><span class="line">exit</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h1 id="ç¬¬ä¸‰æ­¥"><a href="#ç¬¬ä¸‰æ­¥" class="headerlink" title="ç¬¬ä¸‰æ­¥"></a>ç¬¬ä¸‰æ­¥</h1><p>å°†éƒ¨åˆ†å‚æ•°æ›¿æ¢æˆä½ éœ€è¦çš„, ç»ˆç«¯æ‰§è¡Œ deploy.sh, å¼€å§‹è®¿é—® <a href="http://api.site.com" target="_blank" rel="noopener">http://api.site.com</a>, Hello, World!</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;æ­å»º-Docker-Flask-åç«¯&quot;&gt;&lt;a href=&quot;#æ­å»º-Docker-Flask-åç«¯&quot; class=&quot;headerlink&quot; title=&quot;æ­å»º Docker + Flask åç«¯&quot;&gt;&lt;/a&gt;æ­å»º Docker + Flask åç«¯&lt;/h1&gt;&lt;p&gt;ä½¿ç”¨ Docker + Flask + Gunicorn + Gevent + nginx æ¥æ­å»ºçº¯ API åç«¯&lt;/p&gt;&lt;h1 id=&quot;ç›®æ ‡&quot;&gt;&lt;a href=&quot;#ç›®æ ‡&quot; class=&quot;headerlink&quot; title=&quot;ç›®æ ‡&quot;&gt;&lt;/a&gt;ç›®æ ‡&lt;/h1&gt;&lt;p&gt;ä½¿ç”¨ Docker ç¼–æ’ç®¡ç†æœåŠ¡, ä½¿ç”¨ Shell è„šæœ¬ä¸€é”®åŒ–éƒ¨ç½²æµç¨‹&lt;/p&gt;
    
    </summary>
    
      <category term="å¼€å‘å­¦ä¹ " scheme="http://norld.com/categories/%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="Server" scheme="http://norld.com/tags/Server/"/>
    
      <category term="Docker" scheme="http://norld.com/tags/Docker/"/>
    
      <category term="Flask" scheme="http://norld.com/tags/Flask/"/>
    
      <category term="Gunicorn" scheme="http://norld.com/tags/Gunicorn/"/>
    
      <category term="Gevent" scheme="http://norld.com/tags/Gevent/"/>
    
      <category term="nginx" scheme="http://norld.com/tags/nginx/"/>
    
      <category term="åç«¯" scheme="http://norld.com/tags/%E5%90%8E%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>è§£å†³ xcode 10 ç§»é™¤ libstdc++ å¯¼è‡´çš„ file not found é”™è¯¯</title>
    <link href="http://norld.com/2018/12/26/xcode-10-libstdc++/"/>
    <id>http://norld.com/2018/12/26/xcode-10-libstdc++/</id>
    <published>2018-12-26T07:38:50.000Z</published>
    <updated>2019-04-08T01:27:15.995Z</updated>
    
    <content type="html"><![CDATA[<h4 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h4><p>ã€€ã€€è§£å†³ xcode 10 ç§»é™¤ libstdc++ åº“, æ›¿æ¢ä¸º libc++ åº“è€Œå¯¼è‡´æ— æ³•æ‰¾åˆ°å¤´æ–‡ä»¶çš„é—®é¢˜.</p><a id="more"></a><h4 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h4><ol><li><p>å‡†å¤‡æ•°æ®, æ‹‰å– <a href="https://github.com/SYFH/Xcode_libstdc.git" target="_blank" rel="noopener">Xcode_libstdc</a> åˆ°æœ¬åœ°.</p></li><li><p>è¿›å…¥é¡¹ç›®æ ¹ç›®å½•, æ‰§è¡Œ copy.sh è„šæœ¬, å‚æ•°å¿…é¡»å¡«å…¥å½“å‰ xcode.app çš„è·¯å¾„.<br><img src="https://upload-images.jianshu.io/upload_images/3269191-9cd1bcf23bfbe4b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="copy.png"></p></li></ol><ol start="3"><li><p><font color="red"><strong>[æ­¤æ­¥éª¤å¿…é¡»æ‰§è¡Œ]</strong></font> æ‰“å¼€éœ€è¦ libstdc++ çš„é¡¹ç›®, é€‰æ‹© Xcode -&gt; File -&gt; Workspace Settingâ€¦ -&gt; Build System, é€‰æ‹© Legacy Build System, é‡æ–°ç¼–è¯‘.</p></li><li><p>å®Œæˆ!</p></li></ol><h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ:"></a>å‚è€ƒ:</h4><ol><li><a href="https://stackoverflow.com/a/53644801" target="_blank" rel="noopener">stackoverflow ld: library not found for -lstdc++.6</a></li><li><a href="https://stackoverflow.com/a/52757858" target="_blank" rel="noopener">stackoverflow Xcode 10 (iOS 12) does not contain libstdc++6.0.9</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;ç›®æ ‡&quot;&gt;&lt;a href=&quot;#ç›®æ ‡&quot; class=&quot;headerlink&quot; title=&quot;ç›®æ ‡&quot;&gt;&lt;/a&gt;ç›®æ ‡&lt;/h4&gt;&lt;p&gt;ã€€ã€€è§£å†³ xcode 10 ç§»é™¤ libstdc++ åº“, æ›¿æ¢ä¸º libc++ åº“è€Œå¯¼è‡´æ— æ³•æ‰¾åˆ°å¤´æ–‡ä»¶çš„é—®é¢˜.&lt;/p&gt;
    
    </summary>
    
      <category term="å¼€å‘å­¦ä¹ " scheme="http://norld.com/categories/%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="iOS" scheme="http://norld.com/tags/iOS/"/>
    
      <category term="xcode" scheme="http://norld.com/tags/xcode/"/>
    
      <category term="libstdc++" scheme="http://norld.com/tags/libstdc/"/>
    
      <category term="libc++" scheme="http://norld.com/tags/libc/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªç³»ç»ŸBUGå¼•å‘çš„è¡€æ¡ˆ -- FKDownloader</title>
    <link href="http://norld.com/2018/11/29/FKDownloader/"/>
    <id>http://norld.com/2018/11/29/FKDownloader/</id>
    <published>2018-11-29T13:52:30.000Z</published>
    <updated>2018-11-29T13:54:46.000Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æ¥è§¦-BUG"><a href="#æ¥è§¦-BUG" class="headerlink" title="æ¥è§¦ BUG"></a>æ¥è§¦ BUG</h4><p>ã€€ã€€å‰å‡ å¤©çªç„¶æ”¶åˆ°ä¸€æœ‹å‹å‘æ¥çš„æ¶ˆæ¯, è¯´æ˜¯åœ¨ iOS 12 ä¸Šé‡åˆ°äº†ä¸€ä¸ªæ–°çš„ BUG, é—®æˆ‘æ€ä¹ˆçœ‹? æˆ‘è¯´æ–°ç³»ç»Ÿé‡åˆ° BUG ä¸æ˜¯å¾ˆæ­£å¸¸å—? å¤§æ¦‚æ˜¯ä¸ªä»€ä¹ˆæƒ…å†µ?<br>ã€€ã€€ç»è¿‡æœ‹å‹è¯´æ˜, å¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªç°è±¡: ä»–ç”¨äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¸‹è½½ç®¡ç†å™¨è¿›è¡Œè§†é¢‘ä¸‹è½½, æ˜æ˜æ˜¯è®¾ç½®äº†åå°ä¸‹è½½çš„, ä½† App ä¸€æ¨åˆ°åå°å†å›åˆ°å‰å°, ä¸‹è½½è¿›åº¦å°±ä¸åŠ¨äº†, ä½†ä»»åŠ¡ä¾ç„¶è¿˜åœ¨ç»§ç»­ä¸‹è½½. ç³»ç»Ÿæ˜¯ iOS 12, æ‰‹æœºæ˜¯ iPhone 7.<br>ã€€ã€€<br>ã€€ã€€<a id="more"></a></p><h4 id="BUG-è¯¦æƒ…"><a href="#BUG-è¯¦æƒ…" class="headerlink" title="BUG è¯¦æƒ…"></a>BUG è¯¦æƒ…</h4><p>ã€€ã€€åˆšä¸€å¼€å§‹è¿˜ä»¥ä¸ºç¬¬ä¸‰æ–¹åœ¨è¿›åº¦å¤„ç†æ–¹é¢å†™çš„æœ‰é—®é¢˜, ä½†æˆ‘æŠŠè¿™ä¸ªç¬¬ä¸‰æ–¹çš„ <a href="https://github.com/XXDownload/XXDownload" target="_blank" rel="noopener">Demo</a> ä¸‹è½½è¿è¡Œå, å‘ç°è¿™æ ¹æœ¬ä¸æ˜¯ç¬¬ä¸‰æ–¹é—®é¢˜, è€Œæ˜¯ç³»ç»Ÿé—®é¢˜, ç³»ç»Ÿä»£ç† <code>-[NSURLSessionDownloadTask URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:]</code> æ ¹æœ¬æ²¡æœ‰è¢«è°ƒç”¨, æ‰€ä»¥ä¸‹è½½è¿›åº¦æ ¹æœ¬å°±æ— æ³•ç»§ç»­è®¡ç®—.<br>ã€€ã€€ç„¶åæˆ‘æ”¹ä¸ºä½¿ç”¨ KVO ç›‘å¬ <code>NSURLSessionDownloadTask</code> çš„ <code>countOfBytesReceived</code> å’Œ <code>countOfBytesExpectedToReceive</code> å±æ€§æ¥è®¡ç®—å½“å‰ä¸‹è½½è¿›åº¦, ä½†å¾ˆé—æ†¾, è¿™ä¸¤ä¸ªå€¼åœ¨é‡å›å‰å°åå°±æ²¡åœ¨ç»§ç»­å˜åŒ–, åˆæ­¥è®¤å®šæ˜¯ç³»ç»Ÿåœ¨å¤„ç†æ•°æ®æ¥æ”¶æ—¶å‡ºç°äº†å¼‚å¸¸, å¯¼è‡´çœç•¥äº†å€¼çš„æ”¹å˜, è¿˜æœ‰é¡ºä¾¿èººæªçš„è¿›åº¦ä»£ç†.<br>ã€€ã€€ä¸Šä¸€æ¬¡é‡åˆ°è¿™ç§ç³»ç»ŸçŠ¯æ³•å¤±æ•ˆçš„ BUG è¿˜æ˜¯åœ¨ iOS 11.1/11.2 ä¸Š, å½“æ—¶å¼€å‘å½•å±ç›´æ’­, ç³»ç»Ÿæ–¹æ³• <code>-[RPBroadcastSampleHandler processSampleBuffer:withType:]</code> æ²¡æœ‰è¢«è°ƒç”¨, ç›´æ¥å‘æ‰äº†ä¸€ä¸ªå¤§åŠŸèƒ½æ¨¡å—, ä½†å¹¸å¥½, è¿™ä¸€å›é‡åˆ°çš„ BUG ä¸ç®—ä¸¥é‡, è§£å†³æ–¹æ³•è¿˜æ˜¯æœ‰çš„.</p><h4 id="å¼€å§‹æµ‹è¯•"><a href="#å¼€å§‹æµ‹è¯•" class="headerlink" title="å¼€å§‹æµ‹è¯•"></a>å¼€å§‹æµ‹è¯•</h4><p>ã€€ã€€è¿™å›çš„è¿›åº¦ BUG åœ¨è™šæ‹Ÿæœºä¸Šæ˜¯ä¸ä¼šå‡ºç°çš„, å¿…é¡»çœŸæœº, è€Œä¸”ç»è¿‡æµ‹è¯•, å‘ç°åªåœ¨ iOS 12/12.1, iPhone 8 ä»¥ä¸‹æ‰ä¼šå‡ºç°.<br>ã€€ã€€åœ¨æµ‹è¯•æ—¶è¿˜å‘ç° App å®Œå…¨é€€å‡ºå, åå°ä¸‹è½½ä»»åŠ¡ä¼šç›´æ¥å–æ¶ˆ, ä½†æ˜¯å¸¦æœ‰æ¢å¤æ•°æ®.<br>ã€€ã€€è¿›å…¥å‰å°å, æ‰‹åŠ¨è¿›è¡Œ <code>æš‚åœ-&gt;ç»§ç»­</code> æ“ä½œå, ä»£ç†/KVO å°±ä¼šç»§ç»­å·¥ä½œ.</p><h4 id="å°è¯•ä¿®å¤-BUG"><a href="#å°è¯•ä¿®å¤-BUG" class="headerlink" title="å°è¯•ä¿®å¤ BUG"></a>å°è¯•ä¿®å¤ BUG</h4><p>ã€€ã€€æ—¢ç„¶æ‰‹åŠ¨ <code>æš‚åœ-&gt;ç»§ç»­</code> å¯ä»¥ä¿®å¤ BUG, é‚£åªè¦ç”¨ä»£ç é‡ç°ä¸€éå°±å¯ä»¥äº†å§? åˆ«æ€¥, äº‹æƒ…æ²¡æœ‰é‚£ä¹ˆç®€å•.<br>ã€€ã€€ç›´æ¥åœ¨ <code>-[AppDelegate applicationWillEnterForeground:]</code> å¼€å§‹éå†æ‰€æœ‰ä¸‹è½½ä»»åŠ¡, éƒ½æ‰§è¡Œä¸€é <code>æš‚åœ-&gt;ç»§ç»­</code> æ“ä½œ, è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•, å¾ˆç²—æš´, ä½†, è¿™ä¸ç®¡ç”¨!<br>ã€€ã€€é‚£ä¹ˆä½¿ç”¨ <code>-[NSURLSessionDownloadTask cancelByProducingResumeData:]</code> -&gt; <code>-[NSURLSession downloadTaskWithResumeData:]</code> ä»£æ›¿ <code>æš‚åœ-&gt;ç»§ç»­</code> å‘¢? ä¸é”™, æ„è¯†åˆ°å½“å‰çš„ <code>NSURLSessionDownloadTask</code> å¯èƒ½å­˜åœ¨è„æ•°æ®æ˜¯ä¸ªè¿›æ­¥, ä½†, è¿™ä¾ç„¶ä¸ç®¡ç”¨!</p><p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cecf0ab?w=300&amp;h=186&amp;f=gif&amp;s=2049669" alt="ç³»ç»Ÿçš„BUG"></p><p>ã€€ã€€æœ€åçš„æœ€å, è¿˜æ˜¯æµ‹è¯•å‡ºæ¥äº†, å¿…é¡»åœ¨ <code>[AppDelegate applicationDidBecomeActive:]</code> é‡Œé¢éå†ä½¿ç”¨ <code>å–æ¶ˆ-&gt;æ¢å¤</code> æ‰èƒ½æˆåŠŸ</p><h4 id="å…³äºä¸‹è½½å™¨çš„è½®å­"><a href="#å…³äºä¸‹è½½å™¨çš„è½®å­" class="headerlink" title="å…³äºä¸‹è½½å™¨çš„è½®å­"></a>å…³äºä¸‹è½½å™¨çš„è½®å­</h4><p>ã€€ã€€æœ‹å‹è¯´ä½ å†™ä¸€ä¸ªä¸‹è½½ç¬¬ä¸‰æ–¹å§, ç°åœ¨çš„ä¸‹è½½å™¨æ²¡å‡ ä¸ªå¥½ç”¨çš„. å½“æ—¶æˆ‘è¿˜ä¸ä»¥ä¸ºç„¶, è¯´æ˜¯ GitHub ä¸Šé‚£ä¹ˆå¤šè½®å­, ä¸ç¼ºæˆ‘è¿™ä¸€ä¸ª, è€Œä¸”å°±ç®—å†™äº†ä¹Ÿä¸ä¸€å®šæ¯”çƒ­é—¨çš„å¥½, å®åœ¨ä¸è¡Œè¿˜æœ‰ <code>AFNetworking</code> å½“æ‰“åº•çš„.<br>ã€€ã€€æˆ‘åœ¨å¾ˆä¹…ä»¥å‰æˆ‘å°±æ‰“ç®—å†™ä¸€ä¸ªä¸‹è½½å™¨, æƒ³è¦é‡ç‚¹å®ç°å•æ–‡ä»¶å¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½, å½“æ—¶æ•°æ®æµä¸‹è½½å·²ç»å†™å®Œäº†, æ•°æ®æ‹¼æ¥ä¹ŸåŸºæœ¬å®Œæˆäº†, å‡†å¤‡æ”¯æŒåå°ä¸‹è½½æ‰å‘ç°, <code>NSURLSessionDataTask</code> ä¸æ”¯æŒåå°ä¸‹è½½!!! å¥½å§, AppleğŸ‚ğŸºğŸ¤ª<br>ã€€ã€€æˆ‘ä¹Ÿçœ‹äº†æˆ‘æœ‹å‹ç”¨çš„ <a href="https://github.com/XXDownload/XXDownload" target="_blank" rel="noopener">XXDownload</a>, è™½ç„¶ star å°‘äº†ç‚¹, ä½†è¿™ä¸ªåˆšå¥½ç¬¦åˆéœ€æ±‚. è™½ç„¶åœ¨å®ç°ä¸­å¤§èŒƒå›´ä½¿ç”¨ä¸‹åˆ’çº¿å˜é‡, è€Œä¸”è¿˜åœ¨å•ä¾‹ä¸Šä½¿ç”¨ä»£ç†, æ„Ÿè§‰ä¸€å£è€è¡€å¡åœ¨å–‰å’™é‡Œ, ä½†è‡³å°‘æ”¹æ”¹è¿˜æ˜¯èƒ½ç”¨çš„, æ¯•ç«Ÿè¿™ç§ç¬¬ä¸‰æ–¹ä¹Ÿå°±æ˜¯æä¾›ä¸ªæ¡†æ¶è€Œå·².<br>ã€€ã€€è€Œåœ¨ GitHub ä¸Š, å·²ç»æœ‰ä¸€å †é¡¹ç›®åœæ­¢ç»´æŠ¤äº†, è¿˜åœ¨æ›´æ–°çš„, å› ä¸ºä»»åŠ¡æŒä¹…åŒ–ä½¿ç”¨äº†æ•°æ®åº“, å¼•ç”¨äº†å…¶ä»–ç¬¬ä¸‰æ–¹, å¯èƒ½å¯¼è‡´åº“å†²çª, è€Œé‚£äº›è¿˜åœ¨æŒç»­ç»´æŠ¤çš„çº¯å‡€ç‰ˆåˆæ— æ³•é€‚åº”ä¸€äº›éœ€æ±‚åœºæ™¯.<br>ã€€ã€€å…¶ä¸­ <a href="https://github.com/Heikowi/HWIFileDownload" target="_blank" rel="noopener">HWIFileDownload</a> å°±å±äºä¸€ç›´åœ¨æ›´æ–°, ä¹Ÿå¾ˆçº¯å‡€çš„ç¬¬ä¸‰æ–¹, ä¸€èˆ¬é¡¹ç›®ä½¿ç”¨è¶³ä»¥èƒœä»». ä½†åœ¨æŸäº›ç‰¹æ®Šéœ€æ±‚ä¸Šå°±æœ‰ç‚¹ç›¸å½¢è§ç»Œäº†, æ¯”å¦‚æ”¯æŒæ—¶æ•ˆæ€§ä¸‹è½½é“¾æ¥, æŒä¹…åŒ–ä»»åŠ¡åˆ—è¡¨, æ–‡ä»¶æ ¡éªŒ, å¯¹æ¢å¤æ•°æ®æ·±åº¦å¤„ç†ç­‰.<br>ã€€ã€€å½“ç„¶, è¿™éƒ½ä¸æ˜¯é‡ç‚¹, é‡ç‚¹æ˜¯åå°ä¸‹è½½åœºæ™¯å¤ªç¨€å°‘äº†, è‡ªå·±éšæ‰‹å†™ä¸€ä¸ªéƒ½å¯ä»¥å‹‰å¼ºç”¨, è¿˜è¦ä»€ä¹ˆç¬¬ä¸‰æ–¹, è¿™ç§åƒåŠ›ä¸è®¨å¥½, è¿˜åŸºæœ¬æ²¡æœ‰ Star çš„æ“ä½œæˆ‘æ˜¯ä¸ä¼šåšçš„.</p><p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cd5ac60?w=300&amp;h=184&amp;f=gif&amp;s=1019169" alt="çœŸé¦™"></p><h4 id="FKDownloader-â€“-æœ€ç»ˆè¿˜æ˜¯å†™äº†"><a href="#FKDownloader-â€“-æœ€ç»ˆè¿˜æ˜¯å†™äº†" class="headerlink" title="FKDownloader â€“ æœ€ç»ˆè¿˜æ˜¯å†™äº†"></a>FKDownloader â€“ æœ€ç»ˆè¿˜æ˜¯å†™äº†</h4><p>æ—¢ç„¶éƒ½å†™å‡ºæ¥äº†, é‚£å°±å¿…é¡»å°½é‡å®Œç¾, é™¤äº†ä¿®å¤/è§„é¿ iOS çš„ BUG, å½“ç„¶è¿˜éœ€è¦æ”¯æŒä¸€äº›ç‰¹åˆ«çš„éœ€æ±‚.<br>å…ˆåˆ—ä¸€ä¸‹ FKDownloader çš„æ•´ä½“ç»“æ„:</p><ul><li><p>ä¸»ç±»</p><ul><li><p>FKDownloadManager</p><ul><li>è‡ªåŠ è½½, ä¸å¿…æ˜¾å¼è°ƒç”¨åˆ›å»ºå•ä¾‹</li><li>ä¸å¯ç»§æ‰¿, å”¯ä¸€å­˜åœ¨</li><li>ç®¡ç† Task, è¿›è¡Œå¢åˆ æŸ¥æ“ä½œ</li><li>å¼€å§‹/æš‚åœ/æ¢å¤/å–æ¶ˆ Task, ä½†å®ç°ä¸çŠ¶æ€è¿‡æ»¤å…¨æƒç”± Task å®ç°</li><li>æ‰€æœ‰ä»»åŠ¡ä¸‹è½½è¿›åº¦</li><li>åœ¨ AppDelegate å¤„ç†éƒ¨åˆ†åŠŸèƒ½, å¦‚åå°ä¸‹è½½, åŠ è½½ä»»åŠ¡å½’æ¡£, è§£å†³ iOS BUG ç­‰</li></ul></li><li><p>FKConfigure</p><ul><li>ç»Ÿä¸€ç®¡ç†ç‰¹æ®Šé…ç½®</li><li>è®¾ç½® Session Identifier</li><li>è®¾ç½®æ˜¯å¦ä¸ºåå°ä¸‹è½½</li><li>è®¾ç½®æ˜¯å¦è‡ªåŠ¨æ¸…ç†å·²å®Œæˆ/å¤±è´¥ä»»åŠ¡</li><li>è®¾ç½®æ˜¯å¦è‡ªåŠ¨å¼€å§‹ä»»åŠ¡, é’ˆå¯¹è½½å…¥æœ¬åœ°å½’æ¡£ä»»åŠ¡æ—¶</li><li>è‡ªå®šä¹‰è¯·æ±‚è¶…æ—¶æ—¶é—´</li></ul></li><li><p>FKTask</p><ul><li>å¼€å§‹/æš‚åœ/æ¢å¤/å–æ¶ˆçš„å…·ä½“å®ç°</li><li>Block/Delegate/Notification çš„å‘èµ·è€…</li><li>æ ¡éªŒæ–‡ä»¶</li><li>ä¸‹è½½é€Ÿåº¦/é¢„è®¡å‰©ä½™æ—¶é—´</li><li>å¯æ·»åŠ é™„å¸¦ä¿¡æ¯, åŒ…æ‹¬ä¿å­˜æ–‡ä»¶å, æ ¡éªŒä¿¡æ¯, è‡ªå®šä¹‰è¯·æ±‚å¤´ç­‰ä¿¡æ¯</li></ul></li></ul></li><li><p>è¾…ç±»</p><ul><li>FKResumeHelper<ul><li>è§£åŒ…/å°åŒ…æ¢å¤æ•°æ®</li><li>ä¿®å¤ iOS ç‰¹å®šç‰ˆæœ¬ä¸­é”™è¯¯çš„æ¢å¤æ•°æ®</li><li>æ›´æ–°æ¢å¤æ•°æ®çš„ URL</li></ul></li></ul></li><li><p>å…¶ä»–</p><ul><li>FKDefine: å£°æ˜æšä¸¾, C æ–¹æ³•, å­—ç¬¦ä¸²å¸¸é‡</li><li>FKReachability: ç½‘ç»œçŠ¶æ€æ£€æµ‹ä¸ç›‘å¬</li><li>FKDownloadExecutor: ç»Ÿä¸€å¤„ç†ç³»ç»Ÿä»£ç†</li><li>FKTaskStorage: ç®¡ç†ä»»åŠ¡çš„å½’è§£æ¡£</li><li>FKHashHelper: è®¡ç®— Hash</li><li>FKSystemHelper: è·å–è®¾å¤‡ç‰ˆæœ¬, ç³»ç»Ÿç‰ˆæœ¬</li></ul></li></ul><p>FKDownloader ä¸ä¾èµ–å…¶ä»–ä»»ä½•ç¬¬ä¸‰æ–¹, ä¿æŒçº¯å‡€æ€§, å…¶ä¸­çš„æ–¹æ³•å¤§éƒ¨åˆ†éƒ½åå‘äºå¯¹å¤–ç®€å•, å¯¹å†…å¤æ‚, è€Œä¸”å°½é‡é¿å…é«˜è€¦åˆ.</p><h4 id="FKDownloader-æ”¯æŒä¸å®‰è£…"><a href="#FKDownloader-æ”¯æŒä¸å®‰è£…" class="headerlink" title="FKDownloader æ”¯æŒä¸å®‰è£…"></a>FKDownloader æ”¯æŒä¸å®‰è£…</h4><p>å¿…é¡» iOS 8 ä»¥ä¸Š, ä½¿ç”¨ ARC.<br>æ”¯æŒ <code>CocoaPods</code> å’Œ <code>Carthage</code> å®‰è£….<br>å¦‚æœ‰å…¶ä»–éœ€æ±‚, å¯ç›´æ¥å°† <code>FKDownloader</code> æ–‡ä»¶å¤¹ç›´æ¥æ”¾å…¥é¡¹ç›®ä¸­.</p><h4 id="FKDownloader-ç‰¹ç‚¹"><a href="#FKDownloader-ç‰¹ç‚¹" class="headerlink" title="FKDownloader ç‰¹ç‚¹"></a>FKDownloader ç‰¹ç‚¹</h4><ul><li>è‡ªåŠ è½½<br>ã€€ã€€ä½¿ç”¨ <code>+[NSObject load]</code> åŠ è½½å•ä¾‹, ä¸å¿…å†æ˜¾å¼è°ƒç”¨æ¥åˆ›å»ºå•ä¾‹. å› æ­¤å¯ä»¥æå‰ç›‘å¬ <code>AppDelegate</code> é€šçŸ¥, ä¿®å¤è¿›åº¦ BUG å°†å¯ä»¥è‡ªå¤„ç†, ä¸å¿…æ˜¾ç¤ºè°ƒç”¨.</li><li><p>é‡å¯ App æ—¶æ¢å¤ä¸‹è½½ä¸­ä»»åŠ¡è¿›åº¦<br>ã€€ã€€ä¹Ÿå°±æ˜¯å¼€å§‹ä¸€ä¸ªåå°ä¸‹è½½ä»»åŠ¡, å®Œå…¨é€€å‡º App åå†æ¬¡è¿è¡Œ App, éœ€è¦é‡æ–°æ‹¿åˆ°ä¸‹è½½ä»»åŠ¡çš„è¿›åº¦ä¸çŠ¶æ€, ä»¥è¾¾åˆ° UI ä¸Šæ˜¾ç¤ºä»»åŠ¡è¿˜åœ¨è¿è¡Œä¸­çš„æ•ˆæœ.<br>ã€€ã€€å®ç°è¿™ä¸ªåŠŸèƒ½çš„ç¬¬ä¸‰æ–¹æˆ‘åªè§åˆ°ä¸€ä¸¤ä¸ª, è¿™å…¶ä¸­çš„é‡ç‚¹æ˜¯ <code>-[NSURLSession getTasksWithCompletionHandler:]</code> è¿™ä¸ªç³»ç»Ÿæ–¹æ³•, å®ƒå¯ä»¥å°†å¸¦æœ‰ <code>identifier</code> çš„ <code>NSURLSession</code> ä¸­æ‰€æœ‰çš„åå°ä»»åŠ¡è·å–åˆ°.</p></li><li><p>æ”¯æŒæ—¶æ•ˆæ€§ URL<br>ã€€ã€€è·å–åˆ° FKTask å, å¯ç›´æ¥é€šè¿‡ <code>-[FKTask resumeFilePath]</code> è·å– ResumeData ä¿å­˜è·¯å¾„, ä¹‹åç”¨ <code>+[FKResumeHelper updateResumeData:url:]</code> æ‹¿åˆ°æ›´æ–°åçš„ ResumeData, å†ä¿å­˜åå³å¯.<br>ã€€ã€€ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>-[FKTask updateURL:]</code> ç›´æ¥æ›´æ–°, ä½†å¯¹è¿›è¡Œä¸­çš„ä»»åŠ¡æ— æ•ˆ, ä¸”å¿…é¡»å·²å­˜åœ¨æ¢å¤æ•°æ®.<br>ã€€ã€€FKDownloader åªä½¿ç”¨ URL çš„ <code>scheme://host/path</code> åˆ›å»ºæ ‡è¯†ç¬¦, æ‰€ä»¥å‚æ•°å¯ä»¥éšæ„ä¿®æ”¹, å¦‚æœæ˜¯ä½¿ç”¨è¯·æ±‚å¤´å®Œæˆè¿‡æœŸæ“ä½œçš„, å¯ä½¿ç”¨è‡ªå®šä¹‰è¯·æ±‚å¤´.</p></li><li><p>æ ¹æ®ç½‘ç»œçŠ¶æ€æ‰§è¡Œç‰¹å®šæ“ä½œ<br>ã€€ã€€æ£€æµ‹å½“å‰ç½‘ç»œçŠ¶æ€, å¦‚æœæ²¡æœ‰ç½‘ç»œåˆ™æš‚åœè¿›è¡Œä¸­ä»»åŠ¡, å–æ¶ˆç­‰å¾…ä¸­ä»»åŠ¡.<br>ã€€ã€€å½“æ¢å¤ç½‘ç»œæ—¶, å°±ä¼šå°†å› ä¸ºæ— ç½‘ç»œè€Œä¸­æ–­çš„ä»»åŠ¡ç»§ç»­ä¸‹è½½.</p></li><li><p>ä½¿ç”¨ <code>NSCoding</code> æŒä¹…åŒ–ä¸‹è½½ä»»åŠ¡, ä¸ä¾èµ–æ•°æ®åº“<br>ã€€ã€€ç›´æ¥ä¿å­˜ä»»åŠ¡ä¿¡æ¯, åŒ…æ‹¬ URL, ä»»åŠ¡çŠ¶æ€, ä¿å­˜æ–‡ä»¶å, æ ¡éªŒä¿¡æ¯, è‡ªå®šä¹‰è¯·æ±‚å¤´, æ–‡ä»¶æ€»å¤§å°, å·²æ¥æ”¶å­—èŠ‚æ•°ç­‰ä¿¡æ¯, ä¿è¯é‡å¯ App å UI ä¿¡æ¯å’Œé€€å‡º App å‰ä¿æŒä¸€è‡´.<br>ã€€ã€€ä»£ä»·å°±æ˜¯ä¸èƒ½é«˜åº¦è‡ªå®šä¹‰è¦ä¿å­˜çš„æ•°æ®, ä½† <code>FKTask</code> å‘å¤–æš´éœ²çš„å±æ€§å®Œå…¨æ»¡è¶³å¤–æ¥å¼æ•°æ®å¤„ç†éœ€æ±‚, ä¹Ÿå¯ä»¥ä½¿ç”¨é¡¹ç›®ä¸­å·²å­˜åœ¨çš„æ•°æ®åº“è¿›è¡Œè‡ªå®šä¹‰ç®¡ç†.</p></li><li><p>é¢„è§æ€§å¤„ç†çŠ¶æ€/è¿›åº¦<br>ã€€ã€€è®¾ç½®ä»£ç†æ—¶ä¼šå°†å½“å‰æ‰€æœ‰åè®®æ–¹æ³•è§¦å‘ä¸€é, ä¿è¯ UI è·å–çš„ä¿¡æ¯ä¸ºæœ€æ–°.</p></li><li>ä»»åŠ¡çŠ¶æ€/è¿›åº¦çš„ç›‘å¬<br>ã€€ã€€å¯ä»¥è‡ªç”±ä½¿ç”¨ Block/Delegate/Notification è·å–, æœ€å¤§åŒ–è¦†ç›–åº”ç”¨åœºæ™¯.</li><li>è‡ªå®šä¹‰ä»»åŠ¡é™„åŠ ä¿¡æ¯<br>ã€€ã€€ç›®å‰æ”¯æŒä¿å­˜æ–‡ä»¶å, æ–‡ä»¶æ ¡éªŒå€¼, è‡ªå®šä¹‰è¯·æ±‚å¤´.</li><li>æ”¯æŒ URL ä¸­å‚æ•°å¯å˜<br>ã€€ã€€<code>FKTask</code> åªä½¿ç”¨ <code>scheme://host/path</code> åˆ›å»ºæ ‡è¯†ç¬¦, <code>parameters</code> ä¿¡æ¯å°†ç›´æ¥å¿½ç•¥, ä»¥è¯†åˆ«æ—¶æ•ˆæ€§ URL ä¸‹è½½ä»»åŠ¡.</li><li>ç²¾ç»†ä»»åŠ¡çŠ¶æ€<br>ã€€ã€€æ— /é¢„å¤„ç†/ç­‰å¾…/è¿›è¡Œä¸­/å®Œæˆ/å–æ¶ˆ/æš‚åœ/æ¢å¤/æ ¡éªŒ/é”™è¯¯, åŸºæœ¬ä¸Šéƒ½æœ‰ <code>will</code> å’Œ <code>did</code> åŒé‡çº§åˆ«.</li><li>æ–‡ä»¶æ ¡éªŒ<br>ã€€ã€€æ”¯æŒ MD5, SHA1, SHA256, SHA512, ä½†æ ¡éªŒç‰¹å¤§æ–‡ä»¶æ—¶, CPUå ç”¨è¿‡å¤§, æ‰€ä»¥é»˜è®¤é…ç½®ä¸ºå…³é—­éªŒè¯.</li><li>å…¼å®¹ Swift<br>ã€€ã€€æ”¯æŒåœ¨ Swift é¡¹ç›®ä¸­è¿›è¡Œä½¿ç”¨.</li></ul><h4 id="FKDownloader-ç®€å•ä½¿ç”¨"><a href="#FKDownloader-ç®€å•ä½¿ç”¨" class="headerlink" title="FKDownloader ç®€å•ä½¿ç”¨"></a>FKDownloader ç®€å•ä½¿ç”¨</h4><ul><li>ä»»åŠ¡ç®¡ç†</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// æ·»åŠ ä»»åŠ¡, ä½†ä¸æ‰§è¡Œ, é€‚åˆæ‰¹é‡æ·»åŠ ä»»åŠ¡çš„åœºæ™¯</span><br><span class="line">[[FKDownloadManager manager] add:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// æ·»åŠ ä»»åŠ¡, å¹¶é™„åŠ é¢å¤–ä¿¡æ¯, ç›®å‰æ”¯æŒ URL, è‡ªå®šä¹‰ä¿å­˜æ–‡ä»¶å, æ ¡éªŒå€¼, æ ¡éªŒç±»å‹, è‡ªå®šä¹‰è¯·æ±‚å¤´</span><br><span class="line">[[FKDownloadManager manager] addInfo:@&#123;FKTaskInfoURL: url,</span><br><span class="line">                                       FKTaskInfoFileName: @&quot;xCode7&quot;,</span><br><span class="line">                                       FKTaskInfoVerificationType: @(VerifyTypeMD5),</span><br><span class="line">                                       FKTaskInfoVerification: @&quot;5f75fe52c15566a12b012db21808ad8c&quot;,</span><br><span class="line">                                       FKTaskInfoRequestHeader: @&#123;&#125; &#125;];</span><br><span class="line"></span><br><span class="line">// å¼€å§‹æ‰§è¡Œä»»åŠ¡</span><br><span class="line">[[FKDownloadManager manager] start:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// æ ¹æ® URL è·å–ä»»åŠ¡</span><br><span class="line">[[FKDownloadManager manager] acquire:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// æš‚åœä»»åŠ¡</span><br><span class="line">[[FKDownloadManager manager] suspend:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// æ¢å¤ä»»åŠ¡</span><br><span class="line">[[FKDownloadManager manager] resume:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// å–æ¶ˆä»»åŠ¡</span><br><span class="line">[[FKDownloadManager manager] cancel:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// ç§»é™¤ä»»åŠ¡</span><br><span class="line">[[FKDownloadManager manager] remove:@â€œURLâ€];</span><br><span class="line"></span><br><span class="line">// è®¾ç½®ä»»åŠ¡ä»£ç†</span><br><span class="line">[[FKDownloadManager manager] acquire:@â€œURLâ€].delegate = self;</span><br><span class="line"></span><br><span class="line">// è®¾ç½®ä»»åŠ¡ Block</span><br><span class="line">[[FKDownloadManager manager] acquire:@â€œURLâ€].statusBlock = ^(FKTask *task) &#123;</span><br><span class="line">    // çŠ¶æ€æ”¹å˜æ—¶è¢«è°ƒç”¨</span><br><span class="line">&#125;;</span><br><span class="line">[[FKDownloadManager manager] acquire:@â€œURLâ€].speedBlock = ^(FKTask *task) &#123;</span><br><span class="line">    // ä¸‹è½½é€Ÿåº¦, é»˜è®¤ 1s è°ƒç”¨ä¸€æ¬¡</span><br><span class="line">&#125;;</span><br><span class="line">[[FKDownloadManager manager] acquire:@â€œURLâ€].progressBlock = ^(FKTask *task) &#123;</span><br><span class="line">    // è¿›åº¦æ”¹å˜æ—¶è¢«è°ƒç”¨</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>æ”¯æŒçš„ä»»åŠ¡é€šçŸ¥</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// ä¸ä»£ç†åŒä»·, å¯æŒ‰ç…§ä»£ç†çš„ä½¿ç”¨æ–¹å¼ä½¿ç”¨é€šçŸ¥.</span><br><span class="line">extern FKNotificationName const FKTaskPrepareNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidIdleNotification;</span><br><span class="line">extern FKNotificationName const FKTaskWillExecuteNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidExecuteNotication;</span><br><span class="line">extern FKNotificationName const FKTaskProgressNotication;</span><br><span class="line">extern FKNotificationName const FKTaskDidResumingNotification;</span><br><span class="line">extern FKNotificationName const FKTaskWillChecksumNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidChecksumNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidFinishNotication;</span><br><span class="line">extern FKNotificationName const FKTaskErrorNotication;</span><br><span class="line">extern FKNotificationName const FKTaskWillSuspendNotication;</span><br><span class="line">extern FKNotificationName const FKTaskDidSuspendNotication;</span><br><span class="line">extern FKNotificationName const FKTaskWillCancelldNotication;</span><br><span class="line">extern FKNotificationName const FKTaskDidCancelldNotication;</span><br><span class="line">extern FKNotificationName const FKTaskSpeedInfoNotication;</span><br></pre></td></tr></table></figure><ul><li>éœ€è¦åœ¨ AppDelegate ä¸­è°ƒç”¨çš„</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)application:(UIApplication *)application handleEventsForBackgroundURLSession:(NSString *)identifier completionHandler:(void (^)(void))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    // ä¿å­˜åå°ä¸‹è½½æ‰€éœ€çš„ç³»ç»Ÿ Block, åŒºåˆ« identifier ä»¥é˜²æ­¢ä¸å…¶ä»–ç¬¬ä¸‰æ–¹å†²çª</span><br><span class="line">    if ([identifier isEqualToString:[FKDownloadManager manager].configure.sessionIdentifier]) &#123;</span><br><span class="line">        [FKDownloadManager manager].configure.backgroundHandler = completionHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="FKDownloader-å¤„ç†çš„ä¸€äº›ç»†èŠ‚"><a href="#FKDownloader-å¤„ç†çš„ä¸€äº›ç»†èŠ‚" class="headerlink" title="FKDownloader å¤„ç†çš„ä¸€äº›ç»†èŠ‚"></a>FKDownloader å¤„ç†çš„ä¸€äº›ç»†èŠ‚</h4><ul><li>ResumeData<br>ã€€ã€€æ¢å¤æ•°æ®åœ¨ iOS 10.0/10.1 ä¸­å‡ºç°äº†æ ¼å¼é”™è¯¯, å®˜æ–¹åœ¨ iOS 10.2 ä¸­ä¿®å¤æˆåŠŸ, ä½†ä¸ºäº†å…¼å®¹, è¿˜æ˜¯éœ€è¦ä¿®å¤ä¸€ç•ªçš„, å…·ä½“è§£å†³æ–¹æ¡ˆåœ¨<a href="https://stackoverflow.com/questions/39346231/resume-nsurlsession-on-ios10/39347461#39347461" target="_blank" rel="noopener">è¿™é‡Œ</a>.<br>ã€€ã€€è€Œåœ¨ iOS 11 ä¸­, å› ä¸ºå¤šå‡ºäº† <code>NSURLSessionResumeByteRange</code> å­—æ®µå¯¼è‡´ä¸€äº›å¥‡æ€ªçš„é—®é¢˜, å¯ä»¥ä½¿ç”¨ <code>FKResumeHelper</code> å…ˆè¯»å–, åœ¨åˆ é™¤å­—æ®µ, ç„¶åå°åŒ…, ä¹Ÿå¯è‡ªå·±è¿›è¡Œåˆ é™¤, ç›®å‰ FKDownloader å·²è‡ªè¡Œå¤„ç†.<br>ã€€ã€€è™½ç„¶æ²¡æœ‰å‡ºé”™, ä½†åœ¨ iOS 12 ä¸­, ResumeData çš„å°åŒ…æ ¼å¼å‘ç”Ÿäº†æ”¹å˜, <del>ç°åœ¨å¯ä½¿ç”¨ <code>+[NSKeyedUnarchiver unarchiveObjectWithData:]</code> ç›´æ¥è¿›è¡Œè§£åŒ…</del>, ç°åœ¨å¯ä»¥ä½¿ç”¨ <code>-[NSKeyedUnarchiver decodeTopLevelObjectForKey:error:]</code> æ–¹æ³•, <code>key</code> ä¸º <code>NSKeyedArchiveRootObjectKey</code> æ¥è¿›è¡Œè§£åŒ…(è€Œç³»ç»Ÿé»˜è®¤çš„ <code>key</code> æ˜¯ <code>root</code>, Apple æˆ‘ä¸æ˜¯å¾ˆæ‡‚ä½ å•ŠğŸ˜‚), ä½†ä¹‹å‰ç‰ˆæœ¬éœ€è¦ä½¿ç”¨ <code>+[NSPropertyListSerialization propertyListWithData:roptions:format:error:]</code> è¿›è¡Œè§£åŒ…, å°åŒ…æ—¶ä¹Ÿè¦æ³¨æ„åŒºåˆ†.<br>ã€€ã€€åœ¨ iOS 8 ä¸­, å› ä¸º <code>NSURLSessionResumeInfoVersion</code> ç‰ˆæœ¬è¿‡æ—§, æ–°ç‰ˆæœ¬çš„ <code>NSURLSessionResumeInfoTempFileName</code> ä¼šè¢« <code>NSURLSessionResumeInfoLocalPath</code> ä»£æ›¿, ç¼“å­˜æ–‡ä»¶è·¯å¾„å°†ä¸å†åªæ˜¯æ–‡ä»¶å, è€Œæ˜¯æ–‡ä»¶è·¯å¾„, éœ€è¦æ³¨æ„, ä½†å½±å“ä¸å¤§, è¿è¡Œå¹¶æ— é—®é¢˜.<br>ã€€ã€€<img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1f0fd8a5?w=300&amp;h=168&amp;f=gif&amp;s=1899300" alt="Apple å°±æ˜¯å¯ä»¥ä¸ºæ‰€æ¬²ä¸º"></li></ul><p>ã€€ã€€</p><ul><li><p>æ–‡ä»¶æ ¡éªŒ<br>ã€€ã€€åœ¨ä¸‹è½½ä¸€äº›å¤§æ–‡ä»¶æ—¶, ä¸ºäº†ä¿è¯æ–‡ä»¶å®Œæ•´æ€§è€Œéœ€è¦è¿›è¡Œæ–‡ä»¶æ ¡éªŒ, <code>FKDownloader</code> å¯é…ç½®æ˜¯å¦å¼€å¯æ–‡ä»¶æ ¡éªŒ.<br>ã€€ã€€å…¶ä¸­, ä½¿ç”¨ <code>NSDataReadingMappedIfSafe</code> é€‰é¡¹è¿›è¡Œåˆå§‹åŒ– <code>NSData</code>, ä»¥é˜²æ­¢è¶…å¤§æ–‡ä»¶å¯¼è‡´å†…å­˜æº¢å‡º.<br>ã€€ã€€ç»è¿‡æµ‹è¯•, 6G å¤§å°çš„æ–‡ä»¶ç®—å‡º MD5 éœ€è¦ 4~5ç§’, å†…å­˜å ç”¨ &lt; 1M, ä½†å› ä¸º Hash æ“ä½œä¸ºè®¡ç®—å¯†é›†å‹, å¯¼è‡´ CPU å ç”¨ &gt; 90%, æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹, ä¸‹è½½å°å‹æ–‡ä»¶æ—¶å¯å¼€å¯æ–‡ä»¶æ ¡éªŒ, ä½†è¶…å¤§æ–‡ä»¶è¯·é…Œæƒ…å¤„ç†.</p></li><li><p>NSURLSessionDownloadTask<br>ã€€ã€€åœ¨è°ƒç”¨ <code>-[NSURLSessionDownloadTask cancelByProducingResumeData:]</code> å, è™½ç„¶ä»»åŠ¡çŠ¶æ€æ”¹å˜ä¸º <code>NSURLSessionTaskStateCanceling</code>, ä½†åœ¨ä¹‹åä»£ç† <code>-[URLSession URLSession:task:didCompleteWithError:]</code> ä¸­è·å–, çŠ¶æ€ä¸º <code>NSURLSessionTaskStateCompleted</code>, å·®ç‚¹è¢«å‘çš„ä¸è½», æ‰€ä»¥ç›®å‰çŠ¶æ€ç®¡ç†å®Œå…¨ç”± <code>FKTask</code> çš„ <code>status</code> å±æ€§ä»£åŠ³.</p></li><li><p>ç½‘ç»œå¯è¾¾æ€§ Network Reachability<br>ã€€ã€€ä½¿ç”¨ <a href="https://developer.apple.com/library/archive/samplecode/Reachability/Introduction/Intro.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡ä»¶</a> å¤„ç†ç½‘ç»œçŠ¶æ€çš„æ£€æµ‹ä¸ç›‘å¬, ä½†å®˜æ–¹çš„æ–¹å¼åªé€‚åˆçœŸæœºè¿è¡Œ, åœ¨è™šæ‹Ÿæœºä¸­åªå¯ç›‘å¬åˆ°å¤±å»ç½‘ç»œçš„çŠ¶æ€, è€Œå†æ¬¡è¿æ¥ç½‘ç»œçš„çŠ¶æ€æ— æ³•è·å–, ä½†åœ¨çœŸæœºä¸­æ‰€æœ‰çŠ¶æ€éƒ½å¯ç›‘å¬, æ‰€ä»¥æµ‹è¯•ç½‘ç»œçŠ¶æ€æ—¶è¯·ä½¿ç”¨çœŸæœºæµ‹è¯•.</p></li></ul><h4 id="FKDownloader-æœ€ä½³å®è·µ"><a href="#FKDownloader-æœ€ä½³å®è·µ" class="headerlink" title="FKDownloader æœ€ä½³å®è·µ"></a>FKDownloader æœ€ä½³å®è·µ</h4><p>è¯·æŸ¥çœ‹è¿è¡Œ <a href="https://github.com/SYFH/FKDownloader" target="_blank" rel="noopener">Demo</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h4 id=&quot;æ¥è§¦-BUG&quot;&gt;&lt;a href=&quot;#æ¥è§¦-BUG&quot; class=&quot;headerlink&quot; title=&quot;æ¥è§¦ BUG&quot;&gt;&lt;/a&gt;æ¥è§¦ BUG&lt;/h4&gt;&lt;p&gt;ã€€ã€€å‰å‡ å¤©çªç„¶æ”¶åˆ°ä¸€æœ‹å‹å‘æ¥çš„æ¶ˆæ¯, è¯´æ˜¯åœ¨ iOS 12 ä¸Šé‡åˆ°äº†ä¸€ä¸ªæ–°çš„ BUG, é—®æˆ‘æ€ä¹ˆçœ‹? æˆ‘è¯´æ–°ç³»ç»Ÿé‡åˆ° BUG ä¸æ˜¯å¾ˆæ­£å¸¸å—? å¤§æ¦‚æ˜¯ä¸ªä»€ä¹ˆæƒ…å†µ?&lt;br&gt;ã€€ã€€ç»è¿‡æœ‹å‹è¯´æ˜, å¤§æ¦‚æ˜¯è¿™ä¹ˆä¸ªç°è±¡: ä»–ç”¨äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹ä¸‹è½½ç®¡ç†å™¨è¿›è¡Œè§†é¢‘ä¸‹è½½, æ˜æ˜æ˜¯è®¾ç½®äº†åå°ä¸‹è½½çš„, ä½† App ä¸€æ¨åˆ°åå°å†å›åˆ°å‰å°, ä¸‹è½½è¿›åº¦å°±ä¸åŠ¨äº†, ä½†ä»»åŠ¡ä¾ç„¶è¿˜åœ¨ç»§ç»­ä¸‹è½½. ç³»ç»Ÿæ˜¯ iOS 12, æ‰‹æœºæ˜¯ iPhone 7.&lt;br&gt;ã€€ã€€&lt;br&gt;
    
    </summary>
    
      <category term="å¼€å‘å­¦ä¹ " scheme="http://norld.com/categories/%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="iOS" scheme="http://norld.com/tags/iOS/"/>
    
      <category term="åå°ä¸‹è½½" scheme="http://norld.com/tags/%E5%90%8E%E5%8F%B0%E4%B8%8B%E8%BD%BD/"/>
    
      <category term="FKDownloader" scheme="http://norld.com/tags/FKDownloader/"/>
    
      <category term="NSURLSession" scheme="http://norld.com/tags/NSURLSession/"/>
    
      <category term="NSURLSessionDownloadTask" scheme="http://norld.com/tags/NSURLSessionDownloadTask/"/>
    
      <category term="ç¬¬ä¸‰æ–¹åº“" scheme="http://norld.com/tags/%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93/"/>
    
      <category term="iOS BUG" scheme="http://norld.com/tags/iOS-BUG/"/>
    
  </entry>
  
  <entry>
    <title>è·å– XCAsset ä¸­ mp4, mp3 ç­‰éå›¾ç‰‡èµ„æº</title>
    <link href="http://norld.com/2017/12/22/%E8%8E%B7%E5%8F%96%20XCAsset%20%E4%B8%AD%20mp4,%20mp3%20%E7%AD%89%E9%9D%9E%E5%9B%BE%E7%89%87%E8%B5%84%E6%BA%90/"/>
    <id>http://norld.com/2017/12/22/è·å– XCAsset ä¸­ mp4, mp3 ç­‰éå›¾ç‰‡èµ„æº/</id>
    <published>2017-12-22T07:38:50.000Z</published>
    <updated>2017-12-22T07:47:46.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>åœ¨ <code>xcasset</code> æ·»åŠ  <code>Data Set</code> å†…å®¹, å¦‚ <code>.mp3</code>, <code>.mp4</code> ç­‰éå›¾ç‰‡å†…å®¹æ—¶, é€šè¿‡ <code>NSBundle</code> æ— æ³•è·å–æ–‡ä»¶è·¯å¾„, <code>-[NSBundle pathForResource:ofType:]</code> æ–¹æ³•è¿”å›ä¸º <code>nil</code>.</p><h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>ä¸æ”¹å˜æ–‡ä»¶å­˜æ”¾ä½ç½®çš„å‰æä¸‹, è·å–æ–‡ä»¶çš„è·¯å¾„æˆ–äºŒè¿›åˆ¶å†…å®¹.</p><a id="more"></a><h3 id="å‰ç½®"><a href="#å‰ç½®" class="headerlink" title="å‰ç½®"></a>å‰ç½®</h3><p><code>Assets.xcassets</code> å†…é€‰æ‹© <code>+</code> -&gt; é€‰æ‹© <code>New Data Set</code>, å°† <code>demo.mp4</code> æ·»åŠ åˆ°æŒ‡å®šä½ç½®, Set çš„åå­—é‡åä¸º <code>test</code>.</p><h3 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h3><p>é€šè¿‡ <code>NSDataAsset</code> ç±»æ¥è·å– <code>xcasset</code> æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// xcasset å†…åŒ…å« test.mp4 Data Set</span><br><span class="line">NSString *fileName = @&quot;test&quot;;</span><br><span class="line">NSDataAsset *dataAsset = [[NSDataAsset alloc] initWithName:fileName];</span><br><span class="line">[dataAsset.data writeToFile:/* save file path */ atomically:YES]</span><br><span class="line">NSURL *filePath = [NSURL fileURLWithPath:/* save file path */];</span><br></pre></td></tr></table></figure><p>è‡³æ­¤, å°±å¯ä»¥è·å– <code>xcasset</code> ä¸­éå›¾ç‰‡èµ„æºäº†</p><h3 id="æ³¨æ„"><a href="#æ³¨æ„" class="headerlink" title="æ³¨æ„"></a>æ³¨æ„</h3><p><code>NSDataAsset</code> ä¸º <font color="red"><strong>iOS 9.0 åŠä»¥ä¸Š</strong></font> æ‰å¯ä½¿ç”¨çš„æ–¹æ³•</p><h3 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h3><ul><li><a href="https://developer.apple.com/documentation/uikit/nsdataasset?language=objc" target="_blank" rel="noopener">NSDataAsset</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;åœºæ™¯&quot;&gt;&lt;a href=&quot;#åœºæ™¯&quot; class=&quot;headerlink&quot; title=&quot;åœºæ™¯&quot;&gt;&lt;/a&gt;åœºæ™¯&lt;/h3&gt;&lt;p&gt;åœ¨ &lt;code&gt;xcasset&lt;/code&gt; æ·»åŠ  &lt;code&gt;Data Set&lt;/code&gt; å†…å®¹, å¦‚ &lt;code&gt;.mp3&lt;/code&gt;, &lt;code&gt;.mp4&lt;/code&gt; ç­‰éå›¾ç‰‡å†…å®¹æ—¶, é€šè¿‡ &lt;code&gt;NSBundle&lt;/code&gt; æ— æ³•è·å–æ–‡ä»¶è·¯å¾„, &lt;code&gt;-[NSBundle pathForResource:ofType:]&lt;/code&gt; æ–¹æ³•è¿”å›ä¸º &lt;code&gt;nil&lt;/code&gt;.&lt;/p&gt;&lt;h3 id=&quot;ç›®æ ‡&quot;&gt;&lt;a href=&quot;#ç›®æ ‡&quot; class=&quot;headerlink&quot; title=&quot;ç›®æ ‡&quot;&gt;&lt;/a&gt;ç›®æ ‡&lt;/h3&gt;&lt;p&gt;ä¸æ”¹å˜æ–‡ä»¶å­˜æ”¾ä½ç½®çš„å‰æä¸‹, è·å–æ–‡ä»¶çš„è·¯å¾„æˆ–äºŒè¿›åˆ¶å†…å®¹.&lt;/p&gt;
    
    </summary>
    
      <category term="å¼€å‘å­¦ä¹ " scheme="http://norld.com/categories/%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="iOS" scheme="http://norld.com/tags/iOS/"/>
    
      <category term="XCAsset" scheme="http://norld.com/tags/XCAsset/"/>
    
      <category term="æ—¥ç§¯æœˆç´¯" scheme="http://norld.com/tags/%E6%97%A5%E7%A7%AF%E6%9C%88%E7%B4%AF/"/>
    
      <category term="ç¼–ç¨‹æŠ€å·§" scheme="http://norld.com/tags/%E7%BC%96%E7%A8%8B%E6%8A%80%E5%B7%A7/"/>
    
  </entry>
  
  <entry>
    <title>Core Foundation å­¦ä¹  -- å›¾ç‰‡è´¨é‡çš„å‹ç¼©ä¸è½¬æ¢</title>
    <link href="http://norld.com/2017/03/21/Core%20Foundation%20%E5%AD%A6%E4%B9%A0%20--%20%E5%9B%BE%E7%89%87%E8%B4%A8%E9%87%8F%E7%9A%84%E5%8E%8B%E7%BC%A9%E4%B8%8E%E8%BD%AC%E6%8D%A2/"/>
    <id>http://norld.com/2017/03/21/Core Foundation å­¦ä¹  -- å›¾ç‰‡è´¨é‡çš„å‹ç¼©ä¸è½¬æ¢/</id>
    <published>2017-03-21T10:02:00.000Z</published>
    <updated>2017-03-22T06:01:17.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h3><p>&emsp;&emsp;åœ¨ UIKit ä¸­æœ‰ä¸¤ç§å›¾ç‰‡è´¨é‡å‹ç¼©ä¸è½¬æ¢çš„å†™æ³•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UIImageJPEGRepresentation(image, 0.75);</span><br><span class="line">UIImagePNGRepresentation(image);</span><br></pre></td></tr></table></figure><h3 id="ç›®æ ‡"><a href="#ç›®æ ‡" class="headerlink" title="ç›®æ ‡"></a>ç›®æ ‡</h3><p>&emsp;&emsp;ç”¨ <code>Core Foundation</code> å®ç°ç›¸åŒåŠŸèƒ½</p><a id="more"></a><h3 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h3><ul><li>åˆ›å»º <code>Translate</code> ç±»çš„ç›¸å…³æ–‡ä»¶<ul><li>åŒ…å« <code>Translate.h</code> å’Œ <code>Translate.m</code> æ–‡ä»¶</li><li>åˆ é™¤æ‰€æœ‰ <code>@interface</code> å’Œ <code>@implementation</code> ç›¸å…³çš„å†…å®¹<ul><li>è¿™ä¸€æ­¥å¯ä¸åš, ä¹‹åçš„å†…å®¹å¹¶æ²¡æœ‰æ“ä½œ <code>Translate</code> çš„ç±»æˆ–å®ä¾‹å¯¹è±¡</li></ul></li></ul></li><li><p>åœ¨ <code>Translate.h</code> ä¸­</p><ul><li><p>åˆ›å»ºç»“æœç›¸å…³çš„ Blok</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef void(^complet)(BOOL isSuccess);</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ ¼å¼è½¬æ¢ç›¸å…³çš„æšä¸¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSUInteger, kUTType) &#123;</span><br><span class="line">    kUTTypeJPEG,</span><br><span class="line">    kUTTypePNG</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li><li><p>å£°æ˜å®šä¹‰å‹ç¼©è½¬æ¢æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern void TImageRepresentation(NSString *sourceImagePath,NSString *targetImagePatch,double compressionQuality,kUTType type,complet complet);</span><br></pre></td></tr></table></figure></li></ul></li></ul><blockquote><table><thead><tr><th>å‚æ•°</th><th>æ ¼å¼</th><th>å®šä¹‰</th></tr></thead><tbody><tr><td>sourceImagePath</td><td><code>NSString *</code></td><td>åŸå›¾ç‰‡æ–‡ä»¶è·¯å¾„</td></tr><tr><td>targetImagePatch</td><td><code>NSString *</code></td><td>è¾“å‡ºè·¯å¾„, å¿…é¡»åŒ…å«æ–‡ä»¶åä¸åç¼€</td></tr><tr><td>compressionQuality</td><td><code>double</code></td><td>å›¾ç‰‡å‹ç¼©è´¨é‡, èŒƒå›´ 0~1, 1ä¸ºæœ€é«˜è´¨é‡</td></tr><tr><td>type</td><td><code>kUTType</code></td><td>è¾“å‡ºæ ¼å¼, åŠ¡å¿…ä¸è¾“å‡ºè·¯å¾„çš„åç¼€ç›¸åŒ</td></tr><tr><td>complet</td><td><code>Block</code></td><td>è¾“å‡ºç»“æœçš„å›è°ƒ</td></tr></tbody></table></blockquote><ul><li><p>åœ¨ <code>Translate.m</code> ä¸­</p><ul><li><p>å¼•å…¥ç›¸å…³å¤´æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;ImageIO/ImageIO.h&gt;</span><br><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br></pre></td></tr></table></figure></li><li><p>å¼€å§‹å®ç°å‹ç¼©è½¬æ¢æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void TImageRepresentation(NSString *sourceImagePath,</span><br><span class="line">                          NSString *targetImagePatch,</span><br><span class="line">                          double compressionQuality,</span><br><span class="line">                          kUTType type,</span><br><span class="line">                          complet complet) &#123;</span><br><span class="line">    // do something...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¼€å¯å­çº¿ç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">    // do something...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è·å–å›¾ç‰‡æºæ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGImageRef image = [UIImage imageWithContentsOfFile:sourceImagePath].CGImage;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæ¥æ”¶æœ€ç»ˆæ•°æ®çš„ç›®æ ‡å®¹å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFMutableDataRef imageData = CFDataCreateMutable(NULL, 0);</span><br></pre></td></tr></table></figure></li><li><p>åˆ¤æ–­è½¬æ¢æ ¼å¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CFStringRef typeStr;</span><br><span class="line">switch (type) &#123;</span><br><span class="line">    case kUTTypeJPEG:</span><br><span class="line">        typeStr = CFSTR(&quot;public.jpeg&quot;);</span><br><span class="line">        break;</span><br><span class="line">            </span><br><span class="line">    case kUTTypePNG:</span><br><span class="line">        typeStr = CFSTR(&quot;public.png&quot;);</span><br><span class="line">        break;</span><br><span class="line">            </span><br><span class="line">    default:</span><br><span class="line">        break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºè½¬æ¢è€…å¯¹è±¡, è¿›è¡Œè´¨é‡å‹ç¼©å’Œè½¬æ¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGImageDestinationRef destination = CGImageDestinationCreateWithData(imageData, typeStr, 1, NULL);</span><br></pre></td></tr></table></figure><p><code>CGImageDestinationCreateWithData(_,_,_,_)</code> å‡½æ•°çš„<a href="https://developer.apple.com/reference/imageio/1465133-cgimagedestinationcreatewithdata?language=objc" target="_blank" rel="noopener">ç›¸å…³è¯¦æƒ…</a></p></li><li><p>åˆ›å»ºæ‰€éœ€å‚æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSDictionary *properties = @&#123; (__bridge id)kCGImagePropertyMakerNikonQuality : @(compressionQuality) &#125;;</span><br></pre></td></tr></table></figure></li><li><p>å‘è½¬æ¢è€…å¯¹è±¡æ·»åŠ å›¾ç‰‡æ•°æ®å’Œå‚æ•°æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CGImageDestinationAddImage(destination, image, (__bridge CFDictionaryRef)properties);</span><br></pre></td></tr></table></figure><p><code>CGImageDestinationAddImage(_,_,_)</code> å‡½æ•°çš„<a href="https://developer.apple.com/reference/imageio/1464962-cgimagedestinationaddimage?language=objc" target="_blank" rel="noopener">ç›¸å…³è¯¦æƒ…</a></p></li><li><p>æ£€æµ‹è½¬æ¢æ˜¯å¦æˆåŠŸ, å¦‚å¤±è´¥ç›´æ¥é‡Šæ”¾æ•°æ®æºä¸è½¬æ¢è€…å¯¹è±¡, å¹¶ç»“æŸæ‰€æœ‰æµç¨‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if (!CGImageDestinationFinalize(destination)) &#123;</span><br><span class="line">    CFRelease(imageData);</span><br><span class="line">    imageData = NULL;</span><br><span class="line">    if (complet) &#123;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            complet(NO);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    // é‡Šæ”¾è½¬æ¢è€…å¯¹è±¡</span><br><span class="line">    CFRelease(destination);</span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æˆåŠŸåé‡Šæ”¾è½¬æ¢è€…å¯¹è±¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFRelease(destination);</span><br></pre></td></tr></table></figure></li><li><p>æ ¹æ®è¾“å‡ºåœ°å€, åˆ›å»ºè¾“å‡ºæµ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CFAllocatorRef allocator = CFAllocatorGetDefault();</span><br><span class="line">NSURL *fileUrl = [NSURL fileURLWithPath:targetImagePatch];</span><br><span class="line">CFWriteStreamRef writeStream = CFWriteStreamCreateWithFile(allocator, (__bridge CFURLRef)fileUrl);</span><br></pre></td></tr></table></figure></li><li><p>å¼€å¯è¾“å‡ºæµ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFWriteStreamOpen(writeStream);</span><br></pre></td></tr></table></figure></li><li><p>å‘ç›®æ ‡å®¹å™¨å†™å…¥æœ€ç»ˆæ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFIndex result = CFWriteStreamWrite(writeStream, CFDataGetBytePtr(imageData), CFDataGetLength(imageData));</span><br></pre></td></tr></table></figure><p><code>CFWriteStreamWrite(_,_,_)</code> å‡½æ•°çš„<a href="https://developer.apple.com/reference/corefoundation/1539680-cfwritestreamwrite?language=objc" target="_blank" rel="noopener">ç›¸å…³è¯¦æƒ…</a></p></li><li><p>åˆ¤æ–­æœ€ç»ˆæ•°æ®å†™å…¥æ˜¯å¦æˆåŠŸ</p><p>&emsp;&emsp;ä¸æˆåŠŸçš„è¿”å›å€¼ä¸º -1, æˆåŠŸåˆ™ä¸ºè¾“å‡ºçš„å­—èŠ‚æµé•¿åº¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (result != -1) &#123;</span><br><span class="line">    if (complet) &#123;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            complet(YES);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    if (complet) &#123;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            complet(NO);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å…³é—­è¾“å‡ºæµ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFWriteStreamClose(writeStream);</span><br></pre></td></tr></table></figure></li><li><p>é‡Šæ”¾ç›®æ ‡å®¹å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFRelease(imageData);</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>&emsp;&emsp;ç®€å•ä½¿ç”¨:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">NSString *sourceImagePath = @&quot;è¦è¿›è¡Œå¤„ç†çš„å›¾ç‰‡çš„è·¯å¾„&quot;;</span><br><span class="line">NSString *targetImagePath = @&quot;å¤„ç†å®Œæˆçš„è¾“å‡ºè·¯å¾„&quot;;</span><br><span class="line">double compressionQuality = 0.75f;</span><br><span class="line">kUTType targetImageType = kUTTypeJPEG;</span><br><span class="line">    </span><br><span class="line">TImageRepresentation(sourceImagePath, targetImagePath, compressionQuality, targetImageType, ^(BOOL isSuccess) &#123;</span><br><span class="line">    if (isSuccess) &#123;</span><br><span class="line">        NSLog(@&quot;Winer&quot;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        NSLog(@&quot;Loser&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ç›¸å…³"><a href="#ç›¸å…³" class="headerlink" title="ç›¸å…³"></a>ç›¸å…³</h3><ul><li><p><a href="https://developer.apple.com/reference/imageio/cgimagedestination?language=objc" target="_blank" rel="noopener">Apple æ–‡æ¡£ - CGImageâ€‹Destination</a></p></li><li><p><a href="https://developer.apple.com/reference/corefoundation/cfwritestream?language=objc" target="_blank" rel="noopener">Apple æ–‡æ¡£ - CFWriteâ€‹Stream</a></p></li><li><p><a href="https://developer.apple.com/reference/mobilecoreservices/uttype?language=objc" target="_blank" rel="noopener">Apple æ–‡æ¡£ - UTType</a></p></li><li><p><a href="https://developer.apple.com/library/content/documentation/FileManagement/Conceptual/understanding_utis/understand_utis_conc/understand_utis_conc.html#//apple_ref/doc/uid/TP40001319-CH202-BCGJGJGA" target="_blank" rel="noopener">Apple æ–‡æ¡£ - ç»Ÿä¸€ç±»å‹æ ‡è¯†ç¬¦ UTI</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å¼€å§‹&quot;&gt;&lt;a href=&quot;#å¼€å§‹&quot; class=&quot;headerlink&quot; title=&quot;å¼€å§‹&quot;&gt;&lt;/a&gt;å¼€å§‹&lt;/h3&gt;&lt;p&gt;&amp;emsp;&amp;emsp;åœ¨ UIKit ä¸­æœ‰ä¸¤ç§å›¾ç‰‡è´¨é‡å‹ç¼©ä¸è½¬æ¢çš„å†™æ³•:&lt;/p&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;UIImageJPEGRepresentation(image, 0.75);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;UIImagePNGRepresentation(image);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h3 id=&quot;ç›®æ ‡&quot;&gt;&lt;a href=&quot;#ç›®æ ‡&quot; class=&quot;headerlink&quot; title=&quot;ç›®æ ‡&quot;&gt;&lt;/a&gt;ç›®æ ‡&lt;/h3&gt;&lt;p&gt;&amp;emsp;&amp;emsp;ç”¨ &lt;code&gt;Core Foundation&lt;/code&gt; å®ç°ç›¸åŒåŠŸèƒ½&lt;/p&gt;
    
    </summary>
    
      <category term="å¼€å‘å­¦ä¹ " scheme="http://norld.com/categories/%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="iOS" scheme="http://norld.com/tags/iOS/"/>
    
      <category term="Core Foundation" scheme="http://norld.com/tags/Core-Foundation/"/>
    
      <category term="Image I/O" scheme="http://norld.com/tags/Image-I-O/"/>
    
      <category term="ä»¿åˆ¶ç³»ç»Ÿç³»åˆ—" scheme="http://norld.com/tags/%E4%BB%BF%E5%88%B6%E7%B3%BB%E7%BB%9F%E7%B3%BB%E5%88%97/"/>
    
      <category term="å›¾ç‰‡è´¨é‡å‹ç¼©" scheme="http://norld.com/tags/%E5%9B%BE%E7%89%87%E8%B4%A8%E9%87%8F%E5%8E%8B%E7%BC%A9/"/>
    
      <category term="å›¾ç‰‡è½¬æ¢" scheme="http://norld.com/tags/%E5%9B%BE%E7%89%87%E8%BD%AC%E6%8D%A2/"/>
    
  </entry>
  
  <entry>
    <title>æ·±å…¥ç†è§£ [super init]</title>
    <link href="http://norld.com/2017/03/15/%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3%20super%20init/"/>
    <id>http://norld.com/2017/03/15/æ·±åº¦ç†è§£ super init/</id>
    <published>2017-03-15T07:02:00.000Z</published>
    <updated>2017-03-16T08:37:55.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h3><p>&emsp;&emsp;åˆ›å»ºä¸€ä¸ª <code>Test</code> æµ‹è¯•ç±», é‡å†™åˆå§‹åŒ–æ–¹æ³•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)init &#123;</span><br><span class="line">   self = [super init];</span><br><span class="line">   if (self) &#123;</span><br><span class="line">       // do something...</span><br><span class="line">   &#125;</span><br><span class="line">   return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®:"></a>ç–‘é—®:</h3><ul><li>ä¸ºä½•è¦æ‰§è¡Œ <code>[super init]</code> ?</li><li><code>[super init]</code> çš„ç»“æœä¸ºä½•è¦ <code>self</code> æ¥æ”¶?</li></ul><a id="more"></a><h3 id="æ¢ç´¢"><a href="#æ¢ç´¢" class="headerlink" title="æ¢ç´¢:"></a>æ¢ç´¢:</h3><ul><li><code>[super init]</code></li></ul><p>&emsp;&emsp;è¿™ä¸€å¥çœ‹èµ·æ¥å¾ˆæœ‰è¿·æƒ‘æ€§, ä¸€ä¸ª <code>super</code> å…³é”®å­—, å¥½åƒåˆå§‹åŒ–çš„æ˜¯çˆ¶ç±», ä½†åœ¨ç ä»£ç çš„æ—¶å€™å¯ä»¥æ³¨æ„ä¸€ä¸ªç»†èŠ‚: åœ¨å†™ <code>self</code> æ—¶, ä»£ç æç¤ºæ˜¯æœ‰è¿”å›å€¼ç±»å‹çš„, è€Œå†™ <code>[super init]</code> æ—¶, å¹¶æ²¡æœ‰è¿”å›å€¼ç±»å‹, ä½†åœ¨åˆ«å¤„å†™ <code>super</code> æ—¶, è‡ªåŠ¨æç¤ºçš„è¿”å›å€¼ç±»å‹æ˜¯çˆ¶ç±».</p><p>&emsp;&emsp;è¿™è¡¨ç¤ºåœ¨ <code>[super init]</code> è¿™å¥è¯ä¸­, <code>super</code> å¹¶ä¸æ˜¯æŒ‡çˆ¶ç±», å¯èƒ½åªæ˜¯ä¸€ä¸ªæ²¡æœ‰ä»€ä¹ˆåµç”¨çš„å…³é”®å­—, ä½†åœ¨è‹¹æœçš„å®˜æ–¹æ–‡æ¡£ä¸­, è¿™ä¹ˆå†™æ˜¯æ¨èçš„å†™æ³•, é‚£ä¹ˆè¿™å¥è¯å°±å¾ˆå…³é”®äº†.</p><p>&emsp;&emsp;é€šè¿‡ <code>clang -rewrite-objc Test.m</code> å‘½ä»¤, é‡æ–°ç¼–è¯‘æˆ cpp æ–‡ä»¶, å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œä»£ç ç©¶ç«Ÿåšäº†ä»€ä¹ˆ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static instancetype _I_Test_init(Test * self, SEL _cmd) &#123;</span><br><span class="line">    self = ((Test *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;Test&quot;))&#125;, sel_registerName(&quot;init&quot;));</span><br><span class="line">    if (self) &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ç»è¿‡ç®€åŒ–å, <code>[super init]</code> å°±å˜ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objc_msgSendSuper(&#123;self, class_getSuperclass(objc_getClass(&quot;Test&quot;))&#125;, sel_registerName(&quot;init&quot;));</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;è€Œå…¶ä¸­ <code>objc_msgSendSuper()</code> è¿™ä¸ªæ–¹æ³•, API æ–‡æ¡£æ˜¯è¿™æ ·æè¿°çš„:</p><blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void objc_msgSendSuper(void /* struct objc_super *super, SEL op, ... */ )  OBJC_AVAILABLE(10.0, 2.0, 9.0, 1.0);</span><br></pre></td></tr></table></figure></blockquote><blockquote><p>Sends a message with a simple return value to the superclass of an instance of a class.<br>å°†å…·æœ‰è¿”å›å€¼çš„æ¶ˆæ¯å‘é€åˆ°ä¸€ä¸ªå®ä¾‹çš„è¶…ç±».</p></blockquote><p>&emsp;&emsp;ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ <code>objc_suoer</code> ç±»å‹çš„ç»“æ„ä½“, ç¬¬äºŒä¸ªæˆ–æ›´å¤šæ˜¯ <code>SEL</code> æ–¹æ³•é€‰æ‹©å™¨, è€Œåœ¨ <code>runtime.m</code> æ–‡æ¡£ä¸­, <code>objc_super</code> çš„ç»“æ„ä¸º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct objc_super &#123;</span><br><span class="line">    __unsafe_unretained id receiver;</span><br><span class="line">    __unsafe_unretained Class super_class;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<code>receiver</code> æ˜¯å®ä¾‹å¯¹è±¡, <code>super_class</code> æ˜¯ç”¨æ¥æ¥æ”¶æ¶ˆæ¯çš„ç±», ä¸ºå®ä¾‹å¯¹è±¡çš„çˆ¶ç±».</p><p>&emsp;&emsp;åœ¨å½“å‰çš„ä»£ç é‡Œ, <code>receiver</code> ä¸º <code>self</code> , <code>super_class</code> ä¸º <code>NSObject</code> .</p><p>&emsp;&emsp;å†å›è¿‡å¤´æ¥, æ³¨æ„çœ‹ <code>[super init]</code> çš„ c++ æºç , è¿”å›å€¼ä¸º <code>Test *</code>, æ‰€ä»¥åœ¨è¿™é‡Œçš„ <code>init</code> åªæ˜¯å‘ä¸Šåˆå§‹åŒ–çˆ¶ç±»è€Œå·².</p><p>&emsp;&emsp;é‚£ä¹ˆè¿™å°±æ˜äº†äº†, <code>[super init]</code> åªæ˜¯ä¸ºäº†å°†çˆ¶ç±», çˆ¶ç±»çš„çˆ¶ç±», çˆ¶ç±»çš„çˆ¶ç±»çš„çˆ¶ç±»ç­‰ç­‰ç­‰ç­‰, ä» <code>NSObject</code> å¼€å§‹çš„æ‰€æœ‰ç±»éƒ½åˆå§‹åŒ–äº†ä¸€é, åªæ˜¯ä¸ºäº†ç¡®ä¿çˆ¶ç±»çš„æ–¹æ³•, å±æ€§éƒ½èƒ½æ­£ç¡®ä½¿ç”¨è€Œå·².</p><ul><li><code>self = [super init]</code></li></ul><p>&emsp;&emsp;æ—¢ç„¶æ˜ç™½äº† <code>[super init]</code> åšäº†ä»€ä¹ˆ, é‚£ä¹ˆè¿”å›ç»“æœå†èµ‹å€¼ç»™ <code>self</code> å°±åŸºæœ¬æ²¡æœ‰ç–‘é—®äº†: å¦‚æœåœ¨ <code>[super init]</code> è¿™ä¸€æ­¥å› ä¸ºä¸€äº›ä¸æ˜çš„åŸå› å¯¼è‡´åˆå§‹åŒ–å¤±è´¥, é‚£ä¹ˆè¿”å›å€¼åº”è¯¥æ˜¯ä¸º <code>nil</code> çš„, è¿™æ—¶å€™è®© <code>self</code> æ¥æ”¶ä¸€ä¸‹, ä¹‹åç”¨ <code>if</code> åˆ¤æ–­, åˆ™å¯ä»¥é¿å…ä¸€äº› BUG.</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>ä¸ºä½•è¦æ‰§è¡Œ <code>[super init]</code> ?<ul><li>ä¸ºäº†å°†å½“å‰å®ä¾‹çš„çˆ¶ç±»æ ‘è¿›è¡Œåˆå§‹åŒ–, ä»¥ä¿è¯ç»§æ‰¿çˆ¶ç±»æ ‘çš„æ‰€æœ‰å±æ€§ä¸æ–¹æ³•.</li></ul></li><li><code>[super init]</code> çš„ç»“æœä¸ºä½•è¦ <code>self</code> æ¥æ”¶?<ul><li>ä¸ºäº†ç¡®ä¿åˆå§‹åŒ–ä¸ä¼šå› ä¸ºå¤±è´¥è€Œ crash.</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;å¼€å§‹&quot;&gt;&lt;a href=&quot;#å¼€å§‹&quot; class=&quot;headerlink&quot; title=&quot;å¼€å§‹&quot;&gt;&lt;/a&gt;å¼€å§‹&lt;/h3&gt;&lt;p&gt;&amp;emsp;&amp;emsp;åˆ›å»ºä¸€ä¸ª &lt;code&gt;Test&lt;/code&gt; æµ‹è¯•ç±», é‡å†™åˆå§‹åŒ–æ–¹æ³•:&lt;/p&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;- (instancetype)init &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   self = [super init];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   if (self) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;       // do something...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;   return self;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;h3 id=&quot;ç–‘é—®&quot;&gt;&lt;a href=&quot;#ç–‘é—®&quot; class=&quot;headerlink&quot; title=&quot;ç–‘é—®:&quot;&gt;&lt;/a&gt;ç–‘é—®:&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;ä¸ºä½•è¦æ‰§è¡Œ &lt;code&gt;[super init]&lt;/code&gt; ?&lt;/li&gt;&lt;li&gt;&lt;code&gt;[super init]&lt;/code&gt; çš„ç»“æœä¸ºä½•è¦ &lt;code&gt;self&lt;/code&gt; æ¥æ”¶?&lt;/li&gt;&lt;/ul&gt;
    
    </summary>
    
      <category term="å¼€å‘å­¦ä¹ " scheme="http://norld.com/categories/%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0/"/>
    
    
      <category term="iOS" scheme="http://norld.com/tags/iOS/"/>
    
      <category term="Runtime" scheme="http://norld.com/tags/Runtime/"/>
    
      <category term="æ·±å…¥ç†è§£" scheme="http://norld.com/tags/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"/>
    
  </entry>
  
  <entry>
    <title>HelloWorld</title>
    <link href="http://norld.com/2017/01/13/HelloWorld/"/>
    <id>http://norld.com/2017/01/13/HelloWorld/</id>
    <published>2017-01-13T04:33:00.000Z</published>
    <updated>2017-07-12T05:57:23.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="æ–°çš„å¼€å§‹"><a href="#æ–°çš„å¼€å§‹" class="headerlink" title="æ–°çš„å¼€å§‹"></a>æ–°çš„å¼€å§‹</h3><p>hello world!<br><a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;Foundation/Foundation.h&quot;</span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    NSLog(@&quot;Hello world!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;æ–°çš„å¼€å§‹&quot;&gt;&lt;a href=&quot;#æ–°çš„å¼€å§‹&quot; class=&quot;headerlink&quot; title=&quot;æ–°çš„å¼€å§‹&quot;&gt;&lt;/a&gt;æ–°çš„å¼€å§‹&lt;/h3&gt;&lt;p&gt;hello world!&lt;br&gt;
    
    </summary>
    
    
  </entry>
  
</feed>
