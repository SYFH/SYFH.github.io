<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0"><link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.5.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="接触 BUG　　前几天突然收到一朋友发来的消息, 说是在 iOS 12 上遇到了一个新的 BUG, 问我怎么看? 我说新系统遇到 BUG 不是很正常吗? 大概是个什么情况?　　经过朋友说明, 大概是这么个现象: 他用了一个第三方下载管理器进行视频下载, 明明是设置了后台下载的, 但 App 一推到后台再回到前台, 下载进度就不动了, 但任务依然还在继续下载. 系统是 iOS 12, 手机是 iPh"><meta name="keywords" content="iOS,后台下载,FKDownloader,NSURLSession,NSURLSessionDownloadTask,第三方库,iOS BUG"><meta property="og:type" content="article"><meta property="og:title" content="一个系统BUG引发的血案 -- FKDownloader"><meta property="og:url" content="http://norld.com/2018/11/29/FKDownloader/index.html"><meta property="og:site_name" content="Norld&#39;s Blog"><meta property="og:description" content="接触 BUG　　前几天突然收到一朋友发来的消息, 说是在 iOS 12 上遇到了一个新的 BUG, 问我怎么看? 我说新系统遇到 BUG 不是很正常吗? 大概是个什么情况?　　经过朋友说明, 大概是这么个现象: 他用了一个第三方下载管理器进行视频下载, 明明是设置了后台下载的, 但 App 一推到后台再回到前台, 下载进度就不动了, 但任务依然还在继续下载. 系统是 iOS 12, 手机是 iPh"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cecf0ab?w=300&h=186&f=gif&s=2049669"><meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cd5ac60?w=300&h=184&f=gif&s=1019169"><meta property="og:image" content="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1f0fd8a5?w=300&h=168&f=gif&s=1899300"><meta property="og:updated_time" content="2018-11-29T13:54:46.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一个系统BUG引发的血案 -- FKDownloader"><meta name="twitter:description" content="接触 BUG　　前几天突然收到一朋友发来的消息, 说是在 iOS 12 上遇到了一个新的 BUG, 问我怎么看? 我说新系统遇到 BUG 不是很正常吗? 大概是个什么情况?　　经过朋友说明, 大概是这么个现象: 他用了一个第三方下载管理器进行视频下载, 明明是设置了后台下载的, 但 App 一推到后台再回到前台, 下载进度就不动了, 但任务依然还在继续下载. 系统是 iOS 12, 手机是 iPh"><meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cecf0ab?w=300&h=186&f=gif&s=2049669"><link rel="alternate" href="/atom.xml" title="Norld's Blog" type="application/atom+xml"><link rel="canonical" href="http://norld.com/2018/11/29/FKDownloader/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>一个系统BUG引发的血案 -- FKDownloader | Norld's Blog</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Norld's Blog</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://norld.com/2018/11/29/FKDownloader/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Norld"><meta itemprop="description" content="众所周知, 这隐藏着真理<br>显而易见, 这值得去探索"><meta itemprop="image" content="https://norldblog.oss-cn-shanghai.aliyuncs.com/avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Norld's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">一个系统BUG引发的血案 -- FKDownloader</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2018-11-29 21:52:30 / Modified: 21:54:46" itemprop="dateCreated datePublished" datetime="2018-11-29T21:52:30+08:00">2018-11-29</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发学习/" itemprop="url" rel="index"><span itemprop="name">开发学习</span></a></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> Views: <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h4 id="接触-BUG"><a href="#接触-BUG" class="headerlink" title="接触 BUG"></a>接触 BUG</h4><p>　　前几天突然收到一朋友发来的消息, 说是在 iOS 12 上遇到了一个新的 BUG, 问我怎么看? 我说新系统遇到 BUG 不是很正常吗? 大概是个什么情况?<br>　　经过朋友说明, 大概是这么个现象: 他用了一个第三方下载管理器进行视频下载, 明明是设置了后台下载的, 但 App 一推到后台再回到前台, 下载进度就不动了, 但任务依然还在继续下载. 系统是 iOS 12, 手机是 iPhone 7.<br>　　<br>　　<a id="more"></a></p><h4 id="BUG-详情"><a href="#BUG-详情" class="headerlink" title="BUG 详情"></a>BUG 详情</h4><p>　　刚一开始还以为第三方在进度处理方面写的有问题, 但我把这个第三方的 <a href="https://github.com/XXDownload/XXDownload" target="_blank" rel="noopener">Demo</a> 下载运行后, 发现这根本不是第三方问题, 而是系统问题, 系统代理 <code>-[NSURLSessionDownloadTask URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:]</code> 根本没有被调用, 所以下载进度根本就无法继续计算.<br>　　然后我改为使用 KVO 监听 <code>NSURLSessionDownloadTask</code> 的 <code>countOfBytesReceived</code> 和 <code>countOfBytesExpectedToReceive</code> 属性来计算当前下载进度, 但很遗憾, 这两个值在重回前台后就没在继续变化, 初步认定是系统在处理数据接收时出现了异常, 导致省略了值的改变, 还有顺便躺枪的进度代理.<br>　　上一次遇到这种系统犯法失效的 BUG 还是在 iOS 11.1/11.2 上, 当时开发录屏直播, 系统方法 <code>-[RPBroadcastSampleHandler processSampleBuffer:withType:]</code> 没有被调用, 直接坑掉了一个大功能模块, 但幸好, 这一回遇到的 BUG 不算严重, 解决方法还是有的.</p><h4 id="开始测试"><a href="#开始测试" class="headerlink" title="开始测试"></a>开始测试</h4><p>　　这回的进度 BUG 在虚拟机上是不会出现的, 必须真机, 而且经过测试, 发现只在 iOS 12/12.1, iPhone 8 以下才会出现.<br>　　在测试时还发现 App 完全退出后, 后台下载任务会直接取消, 但是带有恢复数据.<br>　　进入前台后, 手动进行 <code>暂停-&gt;继续</code> 操作后, 代理/KVO 就会继续工作.</p><h4 id="尝试修复-BUG"><a href="#尝试修复-BUG" class="headerlink" title="尝试修复 BUG"></a>尝试修复 BUG</h4><p>　　既然手动 <code>暂停-&gt;继续</code> 可以修复 BUG, 那只要用代码重现一遍就可以了吧? 别急, 事情没有那么简单.<br>　　直接在 <code>-[AppDelegate applicationWillEnterForeground:]</code> 开始遍历所有下载任务, 都执行一遍 <code>暂停-&gt;继续</code> 操作, 这个方法很简单, 很粗暴, 但, 这不管用!<br>　　那么使用 <code>-[NSURLSessionDownloadTask cancelByProducingResumeData:]</code> -&gt; <code>-[NSURLSession downloadTaskWithResumeData:]</code> 代替 <code>暂停-&gt;继续</code> 呢? 不错, 意识到当前的 <code>NSURLSessionDownloadTask</code> 可能存在脏数据是个进步, 但, 这依然不管用!</p><p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cecf0ab?w=300&amp;h=186&amp;f=gif&amp;s=2049669" alt="系统的BUG"></p><p>　　最后的最后, 还是测试出来了, 必须在 <code>[AppDelegate applicationDidBecomeActive:]</code> 里面遍历使用 <code>取消-&gt;恢复</code> 才能成功</p><h4 id="关于下载器的轮子"><a href="#关于下载器的轮子" class="headerlink" title="关于下载器的轮子"></a>关于下载器的轮子</h4><p>　　朋友说你写一个下载第三方吧, 现在的下载器没几个好用的. 当时我还不以为然, 说是 GitHub 上那么多轮子, 不缺我这一个, 而且就算写了也不一定比热门的好, 实在不行还有 <code>AFNetworking</code> 当打底的.<br>　　我在很久以前我就打算写一个下载器, 想要重点实现单文件多线程分片下载, 当时数据流下载已经写完了, 数据拼接也基本完成了, 准备支持后台下载才发现, <code>NSURLSessionDataTask</code> 不支持后台下载!!! 好吧, Apple🐂🍺🤪<br>　　我也看了我朋友用的 <a href="https://github.com/XXDownload/XXDownload" target="_blank" rel="noopener">XXDownload</a>, 虽然 star 少了点, 但这个刚好符合需求. 虽然在实现中大范围使用下划线变量, 而且还在单例上使用代理, 感觉一口老血卡在喉咙里, 但至少改改还是能用的, 毕竟这种第三方也就是提供个框架而已.<br>　　而在 GitHub 上, 已经有一堆项目停止维护了, 还在更新的, 因为任务持久化使用了数据库, 引用了其他第三方, 可能导致库冲突, 而那些还在持续维护的纯净版又无法适应一些需求场景.<br>　　其中 <a href="https://github.com/Heikowi/HWIFileDownload" target="_blank" rel="noopener">HWIFileDownload</a> 就属于一直在更新, 也很纯净的第三方, 一般项目使用足以胜任. 但在某些特殊需求上就有点相形见绌了, 比如支持时效性下载链接, 持久化任务列表, 文件校验, 对恢复数据深度处理等.<br>　　当然, 这都不是重点, 重点是后台下载场景太稀少了, 自己随手写一个都可以勉强用, 还要什么第三方, 这种吃力不讨好, 还基本没有 Star 的操作我是不会做的.</p><p><img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1cd5ac60?w=300&amp;h=184&amp;f=gif&amp;s=1019169" alt="真香"></p><h4 id="FKDownloader-–-最终还是写了"><a href="#FKDownloader-–-最终还是写了" class="headerlink" title="FKDownloader – 最终还是写了"></a>FKDownloader – 最终还是写了</h4><p>既然都写出来了, 那就必须尽量完美, 除了修复/规避 iOS 的 BUG, 当然还需要支持一些特别的需求.<br>先列一下 FKDownloader 的整体结构:</p><ul><li><p>主类</p><ul><li><p>FKDownloadManager</p><ul><li>自加载, 不必显式调用创建单例</li><li>不可继承, 唯一存在</li><li>管理 Task, 进行增删查操作</li><li>开始/暂停/恢复/取消 Task, 但实现与状态过滤全权由 Task 实现</li><li>所有任务下载进度</li><li>在 AppDelegate 处理部分功能, 如后台下载, 加载任务归档, 解决 iOS BUG 等</li></ul></li><li><p>FKConfigure</p><ul><li>统一管理特殊配置</li><li>设置 Session Identifier</li><li>设置是否为后台下载</li><li>设置是否自动清理已完成/失败任务</li><li>设置是否自动开始任务, 针对载入本地归档任务时</li><li>自定义请求超时时间</li></ul></li><li><p>FKTask</p><ul><li>开始/暂停/恢复/取消的具体实现</li><li>Block/Delegate/Notification 的发起者</li><li>校验文件</li><li>下载速度/预计剩余时间</li><li>可添加附带信息, 包括保存文件名, 校验信息, 自定义请求头等信息</li></ul></li></ul></li><li><p>辅类</p><ul><li>FKResumeHelper<ul><li>解包/封包恢复数据</li><li>修复 iOS 特定版本中错误的恢复数据</li><li>更新恢复数据的 URL</li></ul></li></ul></li><li><p>其他</p><ul><li>FKDefine: 声明枚举, C 方法, 字符串常量</li><li>FKReachability: 网络状态检测与监听</li><li>FKDownloadExecutor: 统一处理系统代理</li><li>FKTaskStorage: 管理任务的归解档</li><li>FKHashHelper: 计算 Hash</li><li>FKSystemHelper: 获取设备版本, 系统版本</li></ul></li></ul><p>FKDownloader 不依赖其他任何第三方, 保持纯净性, 其中的方法大部分都偏向于对外简单, 对内复杂, 而且尽量避免高耦合.</p><h4 id="FKDownloader-支持与安装"><a href="#FKDownloader-支持与安装" class="headerlink" title="FKDownloader 支持与安装"></a>FKDownloader 支持与安装</h4><p>必须 iOS 8 以上, 使用 ARC.<br>支持 <code>CocoaPods</code> 和 <code>Carthage</code> 安装.<br>如有其他需求, 可直接将 <code>FKDownloader</code> 文件夹直接放入项目中.</p><h4 id="FKDownloader-特点"><a href="#FKDownloader-特点" class="headerlink" title="FKDownloader 特点"></a>FKDownloader 特点</h4><ul><li>自加载<br>　　使用 <code>+[NSObject load]</code> 加载单例, 不必再显式调用来创建单例. 因此可以提前监听 <code>AppDelegate</code> 通知, 修复进度 BUG 将可以自处理, 不必显示调用.</li><li><p>重启 App 时恢复下载中任务进度<br>　　也就是开始一个后台下载任务, 完全退出 App 后再次运行 App, 需要重新拿到下载任务的进度与状态, 以达到 UI 上显示任务还在运行中的效果.<br>　　实现这个功能的第三方我只见到一两个, 这其中的重点是 <code>-[NSURLSession getTasksWithCompletionHandler:]</code> 这个系统方法, 它可以将带有 <code>identifier</code> 的 <code>NSURLSession</code> 中所有的后台任务获取到.</p></li><li><p>支持时效性 URL<br>　　获取到 FKTask 后, 可直接通过 <code>-[FKTask resumeFilePath]</code> 获取 ResumeData 保存路径, 之后用 <code>+[FKResumeHelper updateResumeData:url:]</code> 拿到更新后的 ResumeData, 再保存后即可.<br>　　也可以直接使用 <code>-[FKTask updateURL:]</code> 直接更新, 但对进行中的任务无效, 且必须已存在恢复数据.<br>　　FKDownloader 只使用 URL 的 <code>scheme://host/path</code> 创建标识符, 所以参数可以随意修改, 如果是使用请求头完成过期操作的, 可使用自定义请求头.</p></li><li><p>根据网络状态执行特定操作<br>　　检测当前网络状态, 如果没有网络则暂停进行中任务, 取消等待中任务.<br>　　当恢复网络时, 就会将因为无网络而中断的任务继续下载.</p></li><li><p>使用 <code>NSCoding</code> 持久化下载任务, 不依赖数据库<br>　　直接保存任务信息, 包括 URL, 任务状态, 保存文件名, 校验信息, 自定义请求头, 文件总大小, 已接收字节数等信息, 保证重启 App 后 UI 信息和退出 App 前保持一致.<br>　　代价就是不能高度自定义要保存的数据, 但 <code>FKTask</code> 向外暴露的属性完全满足外接式数据处理需求, 也可以使用项目中已存在的数据库进行自定义管理.</p></li><li><p>预见性处理状态/进度<br>　　设置代理时会将当前所有协议方法触发一遍, 保证 UI 获取的信息为最新.</p></li><li>任务状态/进度的监听<br>　　可以自由使用 Block/Delegate/Notification 获取, 最大化覆盖应用场景.</li><li>自定义任务附加信息<br>　　目前支持保存文件名, 文件校验值, 自定义请求头.</li><li>支持 URL 中参数可变<br>　　<code>FKTask</code> 只使用 <code>scheme://host/path</code> 创建标识符, <code>parameters</code> 信息将直接忽略, 以识别时效性 URL 下载任务.</li><li>精细任务状态<br>　　无/预处理/等待/进行中/完成/取消/暂停/恢复/校验/错误, 基本上都有 <code>will</code> 和 <code>did</code> 双重级别.</li><li>文件校验<br>　　支持 MD5, SHA1, SHA256, SHA512, 但校验特大文件时, CPU占用过大, 所以默认配置为关闭验证.</li><li>兼容 Swift<br>　　支持在 Swift 项目中进行使用.</li></ul><h4 id="FKDownloader-简单使用"><a href="#FKDownloader-简单使用" class="headerlink" title="FKDownloader 简单使用"></a>FKDownloader 简单使用</h4><ul><li>任务管理</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// 添加任务, 但不执行, 适合批量添加任务的场景</span><br><span class="line">[[FKDownloadManager manager] add:@“URL”];</span><br><span class="line"></span><br><span class="line">// 添加任务, 并附加额外信息, 目前支持 URL, 自定义保存文件名, 校验值, 校验类型, 自定义请求头</span><br><span class="line">[[FKDownloadManager manager] addInfo:@&#123;FKTaskInfoURL: url,</span><br><span class="line">                                       FKTaskInfoFileName: @&quot;xCode7&quot;,</span><br><span class="line">                                       FKTaskInfoVerificationType: @(VerifyTypeMD5),</span><br><span class="line">                                       FKTaskInfoVerification: @&quot;5f75fe52c15566a12b012db21808ad8c&quot;,</span><br><span class="line">                                       FKTaskInfoRequestHeader: @&#123;&#125; &#125;];</span><br><span class="line"></span><br><span class="line">// 开始执行任务</span><br><span class="line">[[FKDownloadManager manager] start:@“URL”];</span><br><span class="line"></span><br><span class="line">// 根据 URL 获取任务</span><br><span class="line">[[FKDownloadManager manager] acquire:@“URL”];</span><br><span class="line"></span><br><span class="line">// 暂停任务</span><br><span class="line">[[FKDownloadManager manager] suspend:@“URL”];</span><br><span class="line"></span><br><span class="line">// 恢复任务</span><br><span class="line">[[FKDownloadManager manager] resume:@“URL”];</span><br><span class="line"></span><br><span class="line">// 取消任务</span><br><span class="line">[[FKDownloadManager manager] cancel:@“URL”];</span><br><span class="line"></span><br><span class="line">// 移除任务</span><br><span class="line">[[FKDownloadManager manager] remove:@“URL”];</span><br><span class="line"></span><br><span class="line">// 设置任务代理</span><br><span class="line">[[FKDownloadManager manager] acquire:@“URL”].delegate = self;</span><br><span class="line"></span><br><span class="line">// 设置任务 Block</span><br><span class="line">[[FKDownloadManager manager] acquire:@“URL”].statusBlock = ^(FKTask *task) &#123;</span><br><span class="line">    // 状态改变时被调用</span><br><span class="line">&#125;;</span><br><span class="line">[[FKDownloadManager manager] acquire:@“URL”].speedBlock = ^(FKTask *task) &#123;</span><br><span class="line">    // 下载速度, 默认 1s 调用一次</span><br><span class="line">&#125;;</span><br><span class="line">[[FKDownloadManager manager] acquire:@“URL”].progressBlock = ^(FKTask *task) &#123;</span><br><span class="line">    // 进度改变时被调用</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>支持的任务通知</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 与代理同价, 可按照代理的使用方式使用通知.</span><br><span class="line">extern FKNotificationName const FKTaskPrepareNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidIdleNotification;</span><br><span class="line">extern FKNotificationName const FKTaskWillExecuteNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidExecuteNotication;</span><br><span class="line">extern FKNotificationName const FKTaskProgressNotication;</span><br><span class="line">extern FKNotificationName const FKTaskDidResumingNotification;</span><br><span class="line">extern FKNotificationName const FKTaskWillChecksumNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidChecksumNotification;</span><br><span class="line">extern FKNotificationName const FKTaskDidFinishNotication;</span><br><span class="line">extern FKNotificationName const FKTaskErrorNotication;</span><br><span class="line">extern FKNotificationName const FKTaskWillSuspendNotication;</span><br><span class="line">extern FKNotificationName const FKTaskDidSuspendNotication;</span><br><span class="line">extern FKNotificationName const FKTaskWillCancelldNotication;</span><br><span class="line">extern FKNotificationName const FKTaskDidCancelldNotication;</span><br><span class="line">extern FKNotificationName const FKTaskSpeedInfoNotication;</span><br></pre></td></tr></table></figure><ul><li>需要在 AppDelegate 中调用的</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)application:(UIApplication *)application handleEventsForBackgroundURLSession:(NSString *)identifier completionHandler:(void (^)(void))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    // 保存后台下载所需的系统 Block, 区别 identifier 以防止与其他第三方冲突</span><br><span class="line">    if ([identifier isEqualToString:[FKDownloadManager manager].configure.sessionIdentifier]) &#123;</span><br><span class="line">        [FKDownloadManager manager].configure.backgroundHandler = completionHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="FKDownloader-处理的一些细节"><a href="#FKDownloader-处理的一些细节" class="headerlink" title="FKDownloader 处理的一些细节"></a>FKDownloader 处理的一些细节</h4><ul><li>ResumeData<br>　　恢复数据在 iOS 10.0/10.1 中出现了格式错误, 官方在 iOS 10.2 中修复成功, 但为了兼容, 还是需要修复一番的, 具体解决方案在<a href="https://stackoverflow.com/questions/39346231/resume-nsurlsession-on-ios10/39347461#39347461" target="_blank" rel="noopener">这里</a>.<br>　　而在 iOS 11 中, 因为多出了 <code>NSURLSessionResumeByteRange</code> 字段导致一些奇怪的问题, 可以使用 <code>FKResumeHelper</code> 先读取, 在删除字段, 然后封包, 也可自己进行删除, 目前 FKDownloader 已自行处理.<br>　　虽然没有出错, 但在 iOS 12 中, ResumeData 的封包格式发生了改变, <del>现在可使用 <code>+[NSKeyedUnarchiver unarchiveObjectWithData:]</code> 直接进行解包</del>, 现在可以使用 <code>-[NSKeyedUnarchiver decodeTopLevelObjectForKey:error:]</code> 方法, <code>key</code> 为 <code>NSKeyedArchiveRootObjectKey</code> 来进行解包(而系统默认的 <code>key</code> 是 <code>root</code>, Apple 我不是很懂你啊😂), 但之前版本需要使用 <code>+[NSPropertyListSerialization propertyListWithData:roptions:format:error:]</code> 进行解包, 封包时也要注意区分.<br>　　在 iOS 8 中, 因为 <code>NSURLSessionResumeInfoVersion</code> 版本过旧, 新版本的 <code>NSURLSessionResumeInfoTempFileName</code> 会被 <code>NSURLSessionResumeInfoLocalPath</code> 代替, 缓存文件路径将不再只是文件名, 而是文件路径, 需要注意, 但影响不大, 运行并无问题.<br>　　<img src="https://user-gold-cdn.xitu.io/2018/11/23/1673fc0c1f0fd8a5?w=300&amp;h=168&amp;f=gif&amp;s=1899300" alt="Apple 就是可以为所欲为"></li></ul><p>　　</p><ul><li><p>文件校验<br>　　在下载一些大文件时, 为了保证文件完整性而需要进行文件校验, <code>FKDownloader</code> 可配置是否开启文件校验.<br>　　其中, 使用 <code>NSDataReadingMappedIfSafe</code> 选项进行初始化 <code>NSData</code>, 以防止超大文件导致内存溢出.<br>　　经过测试, 6G 大小的文件算出 MD5 需要 4~5秒, 内存占用 &lt; 1M, 但因为 Hash 操作为计算密集型, 导致 CPU 占用 &gt; 90%, 所以一般情况下, 下载小型文件时可开启文件校验, 但超大文件请酌情处理.</p></li><li><p>NSURLSessionDownloadTask<br>　　在调用 <code>-[NSURLSessionDownloadTask cancelByProducingResumeData:]</code> 后, 虽然任务状态改变为 <code>NSURLSessionTaskStateCanceling</code>, 但在之后代理 <code>-[URLSession URLSession:task:didCompleteWithError:]</code> 中获取, 状态为 <code>NSURLSessionTaskStateCompleted</code>, 差点被坑的不轻, 所以目前状态管理完全由 <code>FKTask</code> 的 <code>status</code> 属性代劳.</p></li><li><p>网络可达性 Network Reachability<br>　　使用 <a href="https://developer.apple.com/library/archive/samplecode/Reachability/Introduction/Intro.html" target="_blank" rel="noopener">官方文件</a> 处理网络状态的检测与监听, 但官方的方式只适合真机运行, 在虚拟机中只可监听到失去网络的状态, 而再次连接网络的状态无法获取, 但在真机中所有状态都可监听, 所以测试网络状态时请使用真机测试.</p></li></ul><h4 id="FKDownloader-最佳实践"><a href="#FKDownloader-最佳实践" class="headerlink" title="FKDownloader 最佳实践"></a>FKDownloader 最佳实践</h4><p>请查看运行 <a href="https://github.com/SYFH/FKDownloader" target="_blank" rel="noopener">Demo</a></p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/iOS/" rel="tag"># iOS</a> <a href="/tags/后台下载/" rel="tag"># 后台下载</a> <a href="/tags/FKDownloader/" rel="tag"># FKDownloader</a> <a href="/tags/NSURLSession/" rel="tag"># NSURLSession</a> <a href="/tags/NSURLSessionDownloadTask/" rel="tag"># NSURLSessionDownloadTask</a> <a href="/tags/第三方库/" rel="tag"># 第三方库</a> <a href="/tags/iOS-BUG/" rel="tag"># iOS BUG</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/12/22/获取 XCAsset 中 mp4, mp3 等非图片资源/" rel="next" title="获取 XCAsset 中 mp4, mp3 等非图片资源"><i class="fa fa-chevron-left"></i> 获取 XCAsset 中 mp4, mp3 等非图片资源</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/12/26/xcode-10-libstdc++/" rel="prev" title="解决 xcode 10 移除 libstdc++ 导致的 file not found 错误">解决 xcode 10 移除 libstdc++ 导致的 file not found 错误 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://norldblog.oss-cn-shanghai.aliyuncs.com/avatar.jpg" alt="Norld"><p class="site-author-name" itemprop="name">Norld</p><p class="site-description motion-element" itemprop="description">众所周知, 这隐藏着真理<br>显而易见, 这值得去探索</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">6</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">1</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">20</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/SYFH" title="GitHub &rarr; https://github.com/SYFH" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:norld@norld.com" title="E-Mail &rarr; mailto:norld@norld.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#接触-BUG"><span class="nav-number">1.</span> <span class="nav-text">接触 BUG</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BUG-详情"><span class="nav-number">2.</span> <span class="nav-text">BUG 详情</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开始测试"><span class="nav-number">3.</span> <span class="nav-text">开始测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#尝试修复-BUG"><span class="nav-number">4.</span> <span class="nav-text">尝试修复 BUG</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关于下载器的轮子"><span class="nav-number">5.</span> <span class="nav-text">关于下载器的轮子</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FKDownloader-–-最终还是写了"><span class="nav-number">6.</span> <span class="nav-text">FKDownloader – 最终还是写了</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FKDownloader-支持与安装"><span class="nav-number">7.</span> <span class="nav-text">FKDownloader 支持与安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FKDownloader-特点"><span class="nav-number">8.</span> <span class="nav-text">FKDownloader 特点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FKDownloader-简单使用"><span class="nav-number">9.</span> <span class="nav-text">FKDownloader 简单使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FKDownloader-处理的一些细节"><span class="nav-number">10.</span> <span class="nav-text">FKDownloader 处理的一些细节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FKDownloader-最佳实践"><span class="nav-number">11.</span> <span class="nav-text">FKDownloader 最佳实践</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Norld</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.7.1</div><span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv" title="Total Visitors"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv" title="Total Views"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script></body></html>